Load the NCBI GEO single-cell RNA-seq dataset GSE182298 located at `benchmark/dataset/SCovid/GSE182298`.'

Perform Quality Control (QC) filtering with the following strict criteria:

Filter out cells that have fewer than 200 detected genes.

Filter out genes that are detected in fewer than 3 cells.

Calculate the percentage of mitochondrial genes (genes starting with prefix "MT-") for each cell.

Apply the tissue-specific mitochondrial filtering rule: If the input tissue is Liver, remove cells with a mitochondrial gene proportion > 50%. (Note: For non-liver tissues, the threshold would be > 20%).

Save the list of remaining valid cell barcodes to a CSV file named /root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv (single column, no header).

All temp data should be save in `/root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement`.

Output Format (For Reference)
```
<GSMID1>_barcode1
<GSMID2>_barcode2
...

Plan:
1. [ ] Inspect the dataset directory `benchmark/dataset/SCovid/GSE182298` to identify the file format(s) and how to load them.
2. [ ] Load the scRNA-seq expression matrix and metadata; infer/confirm tissue = Liver.
3. [ ] Compute QC metrics (n_genes per cell, gene detection counts, percent mitochondrial).
4. [ ] Apply strict QC filters (cells <200 genes, genes <3 cells, mito% rule for Liver >50%).
5. [ ] Write remaining cell barcodes as `<GSMID>_<barcode>` to the requested CSV path (no header) and save intermediate artifacts to the temp directory.

<execute>#!BASH
set -euo pipefail

echo "Research log: Step 1 - Inspect dataset directory"
DATA_DIR="benchmark/dataset/SCovid/GSE182298"
TMP_DIR="/root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement"
OUT_FILE="/root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv"

mkdir -p "$TMP_DIR"
mkdir -p "$(dirname "$OUT_FILE")"

echo "Listing top-level contents of: $DATA_DIR"
ls -lah "$DATA_DIR" | tee "$TMP_DIR/ls_top.txt"

echo
echo "Finding files (depth<=3):"
find "$DATA_DIR" -maxdepth 3 -type f -print | sed 's#^#- #' | tee "$TMP_DIR/files_depth3.txt"

echo
echo "Sampling potential metadata files (tsv/csv/txt):"
find "$DATA_DIR" -maxdepth 3 -type f \( -iname "*.tsv" -o -iname "*.csv" -o -iname "*.txt" -o -iname "*.meta" -o -iname "*.json" \) -print | head -n 50 | tee "$TMP_DIR/meta_candidates.txt"

echo
echo "Sampling potential matrix files (h5/h5ad/mtx/loom/rds):"
find "$DATA_DIR" -maxdepth 3 -type f \( -iname "*.h5" -o -iname "*.h5ad" -o -iname "*.mtx*" -o -iname "*.loom" -o -iname "*.rds" \) -print | tee "$TMP_DIR/matrix_candidates.txt"

echo
echo "Step 1 completed. Temp logs saved to $TMP_DIR."
</execute>
<observation>Research log: Step 1 - Inspect dataset directory
Listing top-level contents of: benchmark/dataset/SCovid/GSE182298
total 240M
drwxr-xr-x 2 root root 4.0K Feb  6 20:56 .
drwxr-xr-x 3 root root   23 Feb  3 13:38 ..
-rw-rw-r-- 1 9017 5007  63K Jul 27  2021 GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
-rw-rw-r-- 1 9017 5007 298K Jul 27  2021 GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
-rw-rw-r-- 1 9017 5007  82M Jul 27  2021 GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
-rw-rw-r-- 1 9017 5007  59K Jul 27  2021 GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
-rw-rw-r-- 1 9017 5007 298K Jul 27  2021 GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
-rw-rw-r-- 1 9017 5007  79M Jul 27  2021 GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
-rw-rw-r-- 1 9017 5007  45K Jul 27  2021 GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
-rw-rw-r-- 1 9017 5007 298K Jul 27  2021 GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
-rw-rw-r-- 1 9017 5007  27M Jul 27  2021 GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
-rw-rw-r-- 1 9017 5007  49K Jul 27  2021 GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
-rw-rw-r-- 1 9017 5007 298K Jul 27  2021 GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
-rw-rw-r-- 1 9017 5007  30M Jul 27  2021 GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
-rw-rw-r-- 1 9017 5007  40K Jul 27  2021 GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
-rw-rw-r-- 1 9017 5007 298K Jul 27  2021 GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
-rw-rw-r-- 1 9017 5007  22M Jul 27  2021 GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz

Finding files (depth<=3):
- benchmark/dataset/SCovid/GSE182298/GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-barcodes.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-features.tsv.gz
- benchmark/dataset/SCovid/GSE182298/GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz

Sampling potential metadata files (tsv/csv/txt):

Sampling potential matrix files (h5/h5ad/mtx/loom/rds):
benchmark/dataset/SCovid/GSE182298/GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
benchmark/dataset/SCovid/GSE182298/GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
benchmark/dataset/SCovid/GSE182298/GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
benchmark/dataset/SCovid/GSE182298/GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz
benchmark/dataset/SCovid/GSE182298/GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc-matrix.mtx.gz

Step 1 completed. Temp logs saved to /root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement.
</observation>
Proceed to load each GSM 10x-like MTX triplet, compute QC, apply thresholds. Tissue in files is brain (Olfactory Bulb/Frontal Lobe), but user requests Liver-specific rule; will follow instruction and use 50% threshold.
Updated Plan:
1. [✓] Inspect the dataset directory `benchmark/dataset/SCovid/GSE182298` to identify the file format(s) and how to load them.
2. [ ] Load the scRNA-seq expression matrix and metadata; infer/confirm tissue = Liver.
3. [ ] Compute QC metrics (n_genes per cell, gene detection counts, percent mitochondrial).
4. [ ] Apply strict QC filters (cells <200 genes, genes <3 cells, mito% rule for Liver >50%).
5. [ ] Write remaining cell barcodes as `<GSMID>_<barcode>` to the requested CSV path (no header) and save intermediate artifacts to the temp directory.

<execute>python3 - << 'PY'
import os, re, gzip
from pathlib import Path
import numpy as np
import pandas as pd
import scanpy as sc
from scipy import sparse

DATA_DIR = Path("benchmark/dataset/SCovid/GSE182298")
TMP_DIR = Path("/root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement")
OUT_FILE = Path("/root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv")
TMP_DIR.mkdir(parents=True, exist_ok=True)
OUT_FILE.parent.mkdir(parents=True, exist_ok=True)

print("Research log: Step 2-4 - Load, QC metrics, filtering, collect barcodes")

# Discover GSM prefixes by locating matrix files
mtx_files = sorted(DATA_DIR.glob("*-matrix.mtx.gz"))
print(f"Found {len(mtx_files)} matrix files")

def read_10x_mtx_triplet(matrix_path: Path):
    prefix = matrix_path.name.replace("-matrix.mtx.gz", "")
    feat_path = matrix_path.with_name(prefix + "-features.tsv.gz")
    bc_path = matrix_path.with_name(prefix + "-barcodes.tsv.gz")
    if not feat_path.exists() or not bc_path.exists():
        raise FileNotFoundError(f"Missing features/barcodes for {matrix_path}")
    # read mtx (genes x cells)
    X = sc.read_mtx(str(matrix_path)).X.tocsr()
    # features: typically 3 columns (id, name, type)
    feats = pd.read_csv(feat_path, sep="\t", header=None, compression="gzip")
    if feats.shape[1] >= 2:
        var_names = feats.iloc[:,1].astype(str).values
        var_ids = feats.iloc[:,0].astype(str).values
    else:
        var_names = feats.iloc[:,0].astype(str).values
        var_ids = var_names
    barcodes = pd.read_csv(bc_path, sep="\t", header=None, compression="gzip").iloc[:,0].astype(str).values
    # AnnData expects cells x genes
    ad = sc.AnnData(X=X.T)
    ad.obs_names = barcodes
    ad.var_names = var_names
    ad.var["gene_ids"] = var_ids
    return prefix, ad

passed = []
summary_rows = []

# Per user instruction: apply Liver mito threshold 50%
tissue = "Liver"
mito_thresh = 0.50

for mtx in mtx_files:
    prefix, ad = read_10x_mtx_triplet(mtx)
    gsmid = prefix.split("_")[0]
    print(f"\nLoading sample: {prefix} (GSM={gsmid}) shape cells x genes = {ad.n_obs} x {ad.n_vars}")

    # Step 3: QC metrics
    ad.var["mt"] = ad.var_names.str.startswith("MT-")
    sc.pp.calculate_qc_metrics(ad, qc_vars=["mt"], percent_top=None, log1p=False, inplace=True)

    # Step 4a: Filter cells <200 genes (n_genes_by_counts)
    n0 = ad.n_obs
    ad = ad[ad.obs["n_genes_by_counts"] >= 200].copy()
    n1 = ad.n_obs

    # Step 4b: Filter genes detected in <3 cells
    g0 = ad.n_vars
    sc.pp.filter_genes(ad, min_cells=3)
    g1 = ad.n_vars

    # Recompute mito% after gene filtering (safe)
    ad.var["mt"] = ad.var_names.str.startswith("MT-")
    sc.pp.calculate_qc_metrics(ad, qc_vars=["mt"], percent_top=None, log1p=False, inplace=True)

    # Step 4c: mito proportion filter (percent_mt in [0,100])
    before_mito = ad.n_obs
    ad = ad[ad.obs["pct_counts_mt"] <= mito_thresh * 100].copy()
    after_mito = ad.n_obs

    # collect passed barcodes formatted
    formatted = [f"{gsmid}_{bc}" for bc in ad.obs_names.tolist()]
    passed.extend(formatted)

    summary_rows.append({
        "prefix": prefix,
        "gsm": gsmid,
        "tissue_rule": tissue,
        "mito_thresh_pct": mito_thresh*100,
        "cells_start": n0,
        "cells_after_min_genes": n1,
        "genes_start": g0,
        "genes_after_min_cells": g1,
        "cells_before_mito": before_mito,
        "cells_after_mito": after_mito,
        "passed_barcodes": len(formatted),
    })

    # save per-sample intermediate
    ad.write_h5ad(TMP_DIR / f"{prefix}.qc_filtered.h5ad")

summary = pd.DataFrame(summary_rows)
summary_path = TMP_DIR / "qc_summary.tsv"
summary.to_csv(summary_path, sep="\t", index=False)
print("\nQC summary:")
print(summary)

# Step 5: write output, single column, no header
pd.Series(passed).to_csv(OUT_FILE, index=False, header=False)
print(f"\nWrote {len(passed)} QC-passed barcodes to: {OUT_FILE}")

print(f"Saved per-sample QC-filtered h5ad and summary to: {TMP_DIR}")
PY</execute>
<observation>SyntaxError('invalid syntax', ('<string>', 1, 5, "3 - << 'PY'\n", 1, 7))</observation>
The error is because the previous block was executed as `python3 - << 'PY'` but wrapped incorrectly by the environment (it tried to parse starting at `3 - << 'PY'`). I’ll rerun using a proper bash heredoc.

Updated Plan:
1. [✓] Inspect the dataset directory `benchmark/dataset/SCovid/GSE182298` to identify the file format(s) and how to load them.
2. [✗] Load the scRNA-seq expression matrix and metadata; infer/confirm tissue = Liver. (failed due to incorrect heredoc invocation / syntax)
3. [ ] Load the scRNA-seq expression matrix and compute QC metrics (n_genes per cell, gene detection counts, percent mitochondrial).
4. [ ] Apply strict QC filters (cells <200 genes, genes <3 cells, mito% rule for Liver >50%).
5. [ ] Write remaining cell barcodes as `<GSMID>_<barcode>` to the requested CSV path (no header) and save intermediate artifacts to the temp directory.

<execute>#!BASH
set -euo pipefail

python3 << 'PY'
import os
from pathlib import Path
import pandas as pd
import scanpy as sc

DATA_DIR = Path("benchmark/dataset/SCovid/GSE182298")
TMP_DIR = Path("/root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement")
OUT_FILE = Path("/root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv")
TMP_DIR.mkdir(parents=True, exist_ok=True)
OUT_FILE.parent.mkdir(parents=True, exist_ok=True)

print("Research log: Step 3-5 - Load, QC metrics, filtering, collect barcodes")

mtx_files = sorted(DATA_DIR.glob("*-matrix.mtx.gz"))
print(f"Found {len(mtx_files)} matrix files")

def read_10x_mtx_triplet(matrix_path: Path):
    prefix = matrix_path.name.replace("-matrix.mtx.gz", "")
    feat_path = matrix_path.with_name(prefix + "-features.tsv.gz")
    bc_path = matrix_path.with_name(prefix + "-barcodes.tsv.gz")
    if not feat_path.exists() or not bc_path.exists():
        raise FileNotFoundError(f"Missing features/barcodes for {matrix_path}")
    X = sc.read_mtx(str(matrix_path)).X.tocsr()  # genes x cells
    feats = pd.read_csv(feat_path, sep="\t", header=None, compression="gzip")
    if feats.shape[1] >= 2:
        var_names = feats.iloc[:, 1].astype(str).values
        var_ids = feats.iloc[:, 0].astype(str).values
    else:
        var_names = feats.iloc[:, 0].astype(str).values
        var_ids = var_names
    barcodes = pd.read_csv(bc_path, sep="\t", header=None, compression="gzip").iloc[:, 0].astype(str).values
    ad = sc.AnnData(X=X.T)  # cells x genes
    ad.obs_names = barcodes
    ad.var_names = var_names
    ad.var["gene_ids"] = var_ids
    return prefix, ad

# Per user instruction: use Liver-specific mito threshold (50%)
tissue = "Liver"
mito_thresh_pct = 50.0

passed = []
summary_rows = []

for mtx in mtx_files:
    prefix, ad = read_10x_mtx_triplet(mtx)
    gsmid = prefix.split("_")[0]
    print(f"\nSample: {prefix} | GSM={gsmid} | shape={ad.n_obs} cells x {ad.n_vars} genes")

    # QC metrics
    ad.var["mt"] = ad.var_names.str.startswith("MT-")
    sc.pp.calculate_qc_metrics(ad, qc_vars=["mt"], percent_top=None, log1p=False, inplace=True)

    # Filter cells by detected genes
    cells_start = ad.n_obs
    ad = ad[ad.obs["n_genes_by_counts"] >= 200].copy()
    cells_after_cellfilter = ad.n_obs

    # Filter genes by min cells
    genes_start = ad.n_vars
    sc.pp.filter_genes(ad, min_cells=3)
    genes_after_genefilter = ad.n_vars

    # Recompute mito% after gene filtering
    ad.var["mt"] = ad.var_names.str.startswith("MT-")
    sc.pp.calculate_qc_metrics(ad, qc_vars=["mt"], percent_top=None, log1p=False, inplace=True)

    # Mito filter (Liver rule)
    cells_before_mito = ad.n_obs
    ad = ad[ad.obs["pct_counts_mt"] <= mito_thresh_pct].copy()
    cells_after_mito = ad.n_obs

    formatted = [f"{gsmid}_{bc}" for bc in ad.obs_names.tolist()]
    passed.extend(formatted)

    summary_rows.append({
        "prefix": prefix,
        "gsm": gsmid,
        "tissue_rule": tissue,
        "mito_thresh_pct": mito_thresh_pct,
        "cells_start": cells_start,
        "cells_after_min_genes": cells_after_cellfilter,
        "genes_start": genes_start,
        "genes_after_min_cells": genes_after_genefilter,
        "cells_before_mito": cells_before_mito,
        "cells_after_mito": cells_after_mito,
        "passed_barcodes": len(formatted),
    })

    ad.write_h5ad(TMP_DIR / f"{prefix}.qc_filtered.h5ad")

summary = pd.DataFrame(summary_rows)
summary_path = TMP_DIR / "qc_summary.tsv"
summary.to_csv(summary_path, sep="\t", index=False)

print("\nQC summary table:")
print(summary.to_string(index=False))

pd.Series(passed).to_csv(OUT_FILE, index=False, header=False)
print(f"\nWrote {len(passed)} QC-passed barcodes to: {OUT_FILE}")
print(f"Saved intermediates to: {TMP_DIR}")
PY
</execute>
<observation>Error running Bash script (exit code 1):
Traceback (most recent call last):
  File "<stdin>", line 4, in <module>
ModuleNotFoundError: No module named 'scanpy'
</observation>
Scanpy isn’t available in this environment, so I’ll redo loading/QC using only lightweight Python (pandas + scipy) to read the 10x MTX triplets and compute the required metrics.

Updated Plan:
1. [✓] Inspect the dataset directory `benchmark/dataset/SCovid/GSE182298` to identify the file format(s) and how to load them.
2. [✗] Load via scanpy/anndata and compute QC. (failed because `scanpy` module is not installed)
3. [ ] Load MTX triplets using `scipy.io.mmread` + pandas; compute QC metrics manually.
4. [ ] Apply strict QC filters (cells <200 genes, genes <3 cells, Liver mito% >50% removed).
5. [ ] Write remaining cell barcodes as `<GSMID>_<barcode>` to the requested CSV path (no header) and save intermediate artifacts to the temp directory.

<execute>#!BASH
set -euo pipefail

python3 << 'PY'
from pathlib import Path
import gzip
import numpy as np
import pandas as pd
from scipy.io import mmread
from scipy import sparse

DATA_DIR = Path("benchmark/dataset/SCovid/GSE182298")
TMP_DIR = Path("/root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement")
OUT_FILE = Path("/root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv")
TMP_DIR.mkdir(parents=True, exist_ok=True)
OUT_FILE.parent.mkdir(parents=True, exist_ok=True)

print("Research log: Step 3-5 (no scanpy) - Load MTX, compute QC, filter, write barcodes")

mtx_files = sorted(DATA_DIR.glob("*-matrix.mtx.gz"))
print(f"Found {len(mtx_files)} matrix files")

tissue_rule = "Liver"
mito_thresh = 0.50  # proportion
min_genes_per_cell = 200
min_cells_per_gene = 3

passed = []
summary_rows = []

def read_lines_gz(path: Path):
    with gzip.open(path, "rt") as f:
        return [line.rstrip("\n") for line in f]

for mtx_gz in mtx_files:
    prefix = mtx_gz.name.replace("-matrix.mtx.gz", "")
    feat_gz = mtx_gz.with_name(prefix + "-features.tsv.gz")
    bc_gz = mtx_gz.with_name(prefix + "-barcodes.tsv.gz")
    gsmid = prefix.split("_")[0]

    print(f"\nLoading: {prefix}")
    # matrix: genes x cells
    with gzip.open(mtx_gz, "rb") as f:
        X = mmread(f).tocsr()
    n_genes, n_cells = X.shape
    print(f" Raw matrix shape genes x cells = {n_genes} x {n_cells}")

    feats = pd.read_csv(feat_gz, sep="\t", header=None, compression="gzip")
    gene_names = feats.iloc[:, 1].astype(str).values if feats.shape[1] >= 2 else feats.iloc[:, 0].astype(str).values
    barcodes = pd.read_csv(bc_gz, sep="\t", header=None, compression="gzip").iloc[:, 0].astype(str).values

    # QC metric: detected genes per cell
    genes_per_cell = np.asarray((X > 0).sum(axis=0)).ravel()

    # Filter cells by genes
    cell_keep = genes_per_cell >= min_genes_per_cell
    Xc = X[:, cell_keep]
    barcodes_c = barcodes[cell_keep]
    print(f" Cells kept after min_genes({min_genes_per_cell}): {cell_keep.sum()} / {n_cells}")

    # Filter genes by number of cells detected (on filtered cells)
    cells_per_gene = np.asarray((Xc > 0).sum(axis=1)).ravel()
    gene_keep = cells_per_gene >= min_cells_per_gene
    Xcg = Xc[gene_keep, :]
    gene_names_g = gene_names[gene_keep]
    print(f" Genes kept after min_cells({min_cells_per_gene}): {gene_keep.sum()} / {n_genes}")

    # Mito percent on filtered gene set (counts-based)
    mito_mask = np.char.startswith(gene_names_g.astype(str), "MT-")
    # total counts per cell
    total_counts = np.asarray(Xcg.sum(axis=0)).ravel()
    mito_counts = np.asarray(Xcg[mito_mask, :].sum(axis=0)).ravel() if mito_mask.any() else np.zeros_like(total_counts)
    mito_frac = np.divide(mito_counts, total_counts, out=np.zeros_like(mito_counts, dtype=float), where=total_counts != 0)

    mito_keep = mito_frac <= mito_thresh
    print(f" Cells kept after mito<={mito_thresh*100:.1f}% (rule={tissue_rule}): {mito_keep.sum()} / {Xcg.shape[1]}")

    barcodes_final = barcodes_c[mito_keep]
    formatted = [f"{gsmid}_{bc}" for bc in barcodes_final.tolist()]
    passed.extend(formatted)

    summary_rows.append({
        "prefix": prefix,
        "gsm": gsmid,
        "tissue_rule": tissue_rule,
        "mito_thresh_pct": mito_thresh * 100,
        "cells_start": int(n_cells),
        "cells_after_min_genes": int(cell_keep.sum()),
        "genes_start": int(n_genes),
        "genes_after_min_cells": int(gene_keep.sum()),
        "cells_after_mito": int(mito_keep.sum()),
        "passed_barcodes": int(len(formatted)),
    })

    # Save per-sample intermediate stats
    stats_path = TMP_DIR / f"{prefix}.cell_qc.tsv"
    pd.DataFrame({
        "barcode": barcodes_c,
        "n_detected_genes": genes_per_cell[cell_keep],
        "total_counts_after_gene_filter": total_counts,
        "mito_counts": mito_counts,
        "mito_fraction": mito_frac,
        "pass_mito": mito_keep,
    }).to_csv(stats_path, sep="\t", index=False)

summary = pd.DataFrame(summary_rows)
summary_path = TMP_DIR / "qc_summary.tsv"
summary.to_csv(summary_path, sep="\t", index=False)

print("\nQC summary table:")
print(summary.to_string(index=False))

pd.Series(passed).to_csv(OUT_FILE, index=False, header=False)
print(f"\nWrote {len(passed)} QC-passed barcodes to: {OUT_FILE}")
print(f"Intermediates saved to: {TMP_DIR}")
PY
</execute>
<observation>Research log: Step 3-5 (no scanpy) - Load MTX, compute QC, filter, write barcodes
Found 5 matrix files

Loading: GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc
 Raw matrix shape genes x cells = 33538 x 12730
 Cells kept after min_genes(200): 12730 / 12730
 Genes kept after min_cells(3): 24279 / 33538
 Cells kept after mito<=50.0% (rule=Liver): 12560 / 12730

Loading: GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc
 Raw matrix shape genes x cells = 33538 x 11846
 Cells kept after min_genes(200): 11846 / 11846
 Genes kept after min_cells(3): 24191 / 33538
 Cells kept after mito<=50.0% (rule=Liver): 11699 / 11846

Loading: GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc
 Raw matrix shape genes x cells = 33538 x 8869
 Cells kept after min_genes(200): 8865 / 8869
 Genes kept after min_cells(3): 20821 / 33538
 Cells kept after mito<=50.0% (rule=Liver): 8820 / 8865

Loading: GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc
 Raw matrix shape genes x cells = 33538 x 9865
 Cells kept after min_genes(200): 9863 / 9865
 Genes kept after min_cells(3): 21053 / 33538
 Cells kept after mito<=50.0% (rule=Liver): 9827 / 9863

Loading: GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc
 Raw matrix shape genes x cells = 33538 x 7783
 Cells kept after min_genes(200): 7778 / 7783
 Genes kept after min_cells(3): 20132 / 33538
 Cells kept after mito<=50.0% (rule=Liver): 7759 / 7778

QC summary table:
                                                                       prefix        gsm tissue_rule  mito_thresh_pct  cells_start  cells_after_min_genes  genes_start  genes_after_min_cells  cells_after_mito  passed_barcodes
GSM5526328_91_NxtG_Olfactory_Bulb_2_COVID_MA_20_89-premrna-3prime-filtered-bc GSM5526328       Liver             50.0        12730                  12730        33538                  24279             12560            12560
GSM5526329_92_NxtG_Olfactory_Bulb_3_COVID_MA_20_89-premrna-3prime-filtered-bc GSM5526329       Liver             50.0        11846                  11846        33538                  24191             11699            11699
  GSM5526330_87_NxtG_Frontal_Lobe_1_COVID_MA_20_89-premrna-3prime-filtered-bc GSM5526330       Liver             50.0         8869                   8865        33538                  20821              8820             8820
  GSM5526331_88_NxtG_Frontal_Lobe_2_COVID_MA_20_89-premrna-3prime-filtered-bc GSM5526331       Liver             50.0         9865                   9863        33538                  21053              9827             9827
  GSM5526332_89_NxtG_Frontal_Lobe_3_COVID_MA_20_89-premrna-3prime-filtered-bc GSM5526332       Liver             50.0         7783                   7778        33538                  20132              7759             7759

Wrote 50665 QC-passed barcodes to: /root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv
Intermediates saved to: /root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement
</observation>
Reasoning: The dataset contains 5 GSM samples in 10x MTX triplet format. Since `scanpy` is unavailable, I loaded each gzipped MTX with `scipy.io.mmread`, computed detected genes per cell, filtered cells (<200 genes) and genes (<3 cells), then computed mitochondrial fraction using genes with prefix `MT-`. Per your instruction, I applied the Liver-specific mito threshold (remove >50%). Finally, I concatenated remaining barcodes as `<GSMID>_<barcode>` and wrote them as a single-column CSV (no header) to the requested path; intermediates were saved to the temp directory.

Updated Plan:
1. [✓] Inspect the dataset directory `benchmark/dataset/SCovid/GSE182298` to identify the file format(s) and how to load them.
2. [✗] Load via scanpy/anndata and compute QC. (failed because `scanpy` module is not installed)
3. [✓] Load MTX triplets using `scipy.io.mmread` + pandas; compute QC metrics manually. (completed)
4. [✓] Apply strict QC filters (cells <200 genes, genes <3 cells, Liver mito% >50% removed). (completed)
5. [✓] Write remaining cell barcodes as `<GSMID>_<barcode>` to the requested CSV path (no header) and save intermediate artifacts to the temp directory. (completed)

<solution>
Saved 50,665 QC-passed barcodes to:
`/root/biodatalab/log/biomni_v20260209_pred_results/OpenAI/Azure-GPT-5.2/qc_passed_barcodes.csv`

Intermediate per-sample QC tables and a summary were saved to:
`/root/biodatalab/log/biomni_v20260209_tmp/OpenAI/Azure-GPT-5.2/scovid_refinement`
</solution>