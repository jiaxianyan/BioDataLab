
Perform a differential expression analysis for 6 DRX experiments in `benchmark/dataset/MetazExp/count`. 

The basic information of the 6 DRX experiments is provided in `benchmark/dataset/MetazExp/sample_info.tsv`, which includes sample annotations specifying biological conditions (e.g., tissue, developmental stage) and study or batch identifiers.

You must explicitly correct for study-specific batch effects by including the batch variable in the design formula (e.g., design = ~ batch + condition).

Identify genes that are significantly differentially expressed in the target condition compared to all other conditions combined.

Output the top 50 most significantly differentially expressed genes (ranked by adjusted p-value) to `/root/autodl-tmp/biomni_v20260208_pred_results/qwen3-max-2026-01-23/metazexp_annotate.tsv`.

Output Format (Only for Reference):
gene_id	baseMean	log2FoldChange	lfcSE	stat	pvalue	padj
FBgnxxxx	1254.66665476386	-2.87772911936465	0.87905045247991	-27.2422049305457	2.05567383473253e-163	3.25310384346423e-159
FBgnyyyy	52136.516872705251	-4.730648430188	0.676023255336235	-24.3843527676287	2.50655533940541e-131	1.98331191230453e-127

All temp data should be save in `/root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate`.

I need to perform a differential expression analysis on 6 DRX experiments. Let me break down what I need to do:

1. First, I need to examine the data structure and understand what files are available
2. Load the count data and sample information
3. Set up a DESeq2 analysis with batch correction
4. Perform differential expression analysis comparing target condition vs all others
5. Extract top 50 significant genes and save to the specified output file

Let me start by exploring the available data.

<execute>
#!BASH
ls -la benchmark/dataset/MetazExp/
</execute>
<observation>total 24
drwxr-xr-x  8 root root 4096 Feb  7 15:40 .
drwxr-xr-x 48 root root 4096 Feb  8 20:44 ..
-rw-------  1 root root 1593 Feb  4 14:54 README.md
drwxr-xr-x  2 root root   70 Feb  5 15:59 SRR2131217
drwxr-xr-x  2 root root 4096 Feb  7 15:40 count
-rw-------  1 root root  593 Feb  4 14:58 md5sum.txt
drwxr-xr-x  3 root root   26 Feb  7 15:40 ncbi_dataset
-rw-r--r--  1 root root  862 Feb  7 15:41 sample_info.tsv
drwxr-xr-x  2 root root   70 Feb  5 16:38 toy_srr1
drwxr-xr-x  2 root root   70 Feb  5 16:17 toy_srr2
drwxr-xr-x  2 root root   70 Feb  5 16:27 toy_srr3
</observation>
<execute>
#!BASH
ls -la benchmark/dataset/MetazExp/count/
</execute>
<observation>total 4620
drwxr-xr-x 2 root root   4096 Feb  7 15:40 .
drwxr-xr-x 8 root root   4096 Feb  7 15:40 ..
-rw-r--r-- 1 root root 788513 Feb  5 17:43 DRX198149.gene.expr.tsv
-rw-r--r-- 1 root root 790126 Feb  5 17:43 DRX198150.gene.expr.tsv
-rw-r--r-- 1 root root 789857 Feb  5 17:43 DRX198151.gene.expr.tsv
-rw-r--r-- 1 root root 781085 Feb  5 17:43 DRX198152.gene.expr.tsv
-rw-r--r-- 1 root root 779207 Feb  5 17:43 DRX198153.gene.expr.tsv
-rw-r--r-- 1 root root 782338 Feb  5 17:43 DRX198154.gene.expr.tsv
</observation>
<execute>
head -n 5 benchmark/dataset/MetazExp/sample_info.tsv
</execute>
<observation>SyntaxError('invalid syntax', ('<string>', 1, 9, 'head -n 5 benchmark/dataset/MetazExp/sample_info.tsv\n', 1, 10))</observation>
<execute>
#!BASH
head -n 5 benchmark/dataset/MetazExp/sample_info.tsv
</execute>
<observation>
Study	Experiment	Source	Strain	Genotype	DevelopmentDevelopment	Tissue	TreatmentTreatment	Mapped Bases	SeqLen
DRP006530	DRX198149	PMID:32865275	/	UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+	L3	hemocyte	cancer-bearing	22.50GB	PE150				
DRP006530	DRX198150	PMID:32865275	/	UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+	L3	hemocyte	cancer-bearing	23.76GB	PE150				
DRP006530	DRX198151	PMID:32865275	/	UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+	L3	hemocyte	cancer-bearing	24.17GB	PE150				
</observation>
<execute>
#!BASH
cat benchmark/dataset/MetazExp/sample_info.tsv
</execute>
<observation>
Study	Experiment	Source	Strain	Genotype	DevelopmentDevelopment	Tissue	TreatmentTreatment	Mapped Bases	SeqLen
DRP006530	DRX198149	PMID:32865275	/	UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+	L3	hemocyte	cancer-bearing	22.50GB	PE150				
DRP006530	DRX198150	PMID:32865275	/	UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+	L3	hemocyte	cancer-bearing	23.76GB	PE150				
DRP006530	DRX198151	PMID:32865275	/	UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+	L3	hemocyte	cancer-bearing	24.17GB	PE150				
DRP006530	DRX198152	PMID:32865275	/	en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+	L3	hemocyte	non-cancer control	23.81GB	PE150				
DRP006530	DRX198153	PMID:32865275	/	en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+	L3	hemocyte	non-cancer control	22.40GB	PE150				
DRP006530	DRX198154	PMID:32865275	/	en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+	L3	hemocyte	non-cancer control	24.13GB	PE150				</observation>
Now I can see the structure. There are 6 experiments (DRX198149-DRX198154) with two conditions:
- cancer-bearing (DRX198149, DRX198150, DRX198151)
- non-cancer control (DRX198152, DRX198153, DRX198154)

All samples are from the same study (DRP006530), so there's only one batch. However, the instruction says to explicitly correct for study-specific batch effects, so I'll include the Study column as a batch variable.

Let me check the format of the count files:

<execute>
#!BASH
head -n 3 benchmark/dataset/MetazExp/count/DRX198149.gene.expr.tsv
</execute>
<observation>geneId	readCount	Coverage	FPKM	TPM
FBgn0039635	20831	1530.846436	105.496330	161.640015
FBgn0086355	28769	2769.733643	150.103287	229.986176
</observation>
I need to extract just the geneId and readCount columns for DESeq2 analysis. Let me create a plan:

1. [ ] Create output directory
2. [ ] Read all count files and extract geneId and readCount
3. [ ] Create a combined count matrix
4. [ ] Load sample information
5. [ ] Set up DESeq2 analysis with batch correction
6. [ ] Run differential expression analysis
7. [ ] Extract top 50 significant genes
8. [ ] Save results to specified file

Let me start implementing this:

<execute>
import os
import pandas as pd
import numpy as np

# Create output directory
output_dir = "/root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate"
os.makedirs(output_dir, exist_ok=True)

print("Output directory created:", output_dir)
</execute>
<observation>Output directory created: /root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate
</observation>
1. [✓] Create output directory

Now let me read all count files and create a combined count matrix:

<execute>
# Read all count files
count_files = [
    "DRX198149.gene.expr.tsv",
    "DRX198150.gene.expr.tsv", 
    "DRX198151.gene.expr.tsv",
    "DRX198152.gene.expr.tsv",
    "DRX198153.gene.expr.tsv",
    "DRX198154.gene.expr.tsv"
]

count_dir = "benchmark/dataset/MetazExp/count"

# Create empty dictionary to store counts
count_data = {}

for file in count_files:
    sample_id = file.replace(".gene.expr.tsv", "")
    file_path = os.path.join(count_dir, file)
    df = pd.read_csv(file_path, sep="\t")
    # Use geneId as index and readCount as values
    count_data[sample_id] = df.set_index("geneId")["readCount"]

# Create combined count matrix
count_matrix = pd.DataFrame(count_data)
print("Count matrix shape:", count_matrix.shape)
print("First few rows:")
print(count_matrix.head())
</execute>
<observation>NameError("name 'os' is not defined")</observation>
<execute>
import os
import pandas as pd

# Read all count files
count_files = [
    "DRX198149.gene.expr.tsv",
    "DRX198150.gene.expr.tsv", 
    "DRX198151.gene.expr.tsv",
    "DRX198152.gene.expr.tsv",
    "DRX198153.gene.expr.tsv",
    "DRX198154.gene.expr.tsv"
]

count_dir = "benchmark/dataset/MetazExp/count"

# Create empty dictionary to store counts
count_data = {}

for file in count_files:
    sample_id = file.replace(".gene.expr.tsv", "")
    file_path = os.path.join(count_dir, file)
    df = pd.read_csv(file_path, sep="\t")
    # Use geneId as index and readCount as values
    count_data[sample_id] = df.set_index("geneId")["readCount"]

# Create combined count matrix
count_matrix = pd.DataFrame(count_data)
print("Count matrix shape:", count_matrix.shape)
print("First few rows:")
print(count_matrix.head())
</execute>
<observation>Count matrix shape: (17714, 6)
First few rows:
             DRX198149  DRX198150  DRX198151  DRX198152  DRX198153  DRX198154
geneId                                                                       
FBgn0000003       1511       1992       1345        386       5597       2064
FBgn0000008       2577       2747       2834       5381       2719       3226
FBgn0000014       1273        994       1305       2563        939        960
FBgn0000015       1565         78        502         93        111         85
FBgn0000017       9798      10853      10323      15360      17951      20272
</observation>
2. [✓] Read all count files and extract geneId and readCount
3. [✓] Create a combined count matrix

Now let me load the sample information:

<execute>
# Load sample information
sample_info = pd.read_csv("benchmark/dataset/MetazExp/sample_info.tsv", sep="\t")
print("Sample info shape:", sample_info.shape)
print("Sample info columns:", sample_info.columns.tolist())
print("Sample info:")
print(sample_info)

# Create condition vector
# Based on TreatmentTreatment column: "cancer-bearing" vs "non-cancer control"
conditions = []
for treatment in sample_info["TreatmentTreatment"]:
    if "cancer-bearing" in str(treatment):
        conditions.append("cancer-bearing")
    else:
        conditions.append("non-cancer control")

# Create batch vector (Study column)
batches = sample_info["Study"].tolist()

print("\nConditions:", conditions)
print("Batches:", batches)
</execute>
<observation>NameError("name 'pd' is not defined")</observation>
<execute>
import pandas as pd

# Load sample information
sample_info = pd.read_csv("benchmark/dataset/MetazExp/sample_info.tsv", sep="\t")
print("Sample info shape:", sample_info.shape)
print("Sample info columns:", sample_info.columns.tolist())
print("Sample info:")
print(sample_info)

# Create condition vector
# Based on TreatmentTreatment column: "cancer-bearing" vs "non-cancer control"
conditions = []
for treatment in sample_info["TreatmentTreatment"]:
    if "cancer-bearing" in str(treatment):
        conditions.append("cancer-bearing")
    else:
        conditions.append("non-cancer control")

# Create batch vector (Study column)
batches = sample_info["Study"].tolist()

print("\nConditions:", conditions)
print("Batches:", batches)
</execute>
<observation>Sample info shape: (6, 10)
Sample info columns: ['Study', 'Experiment', 'Source', 'Strain', 'Genotype', 'DevelopmentDevelopment', 'Tissue', 'TreatmentTreatment', 'Mapped Bases', 'SeqLen']
Sample info:
                                                                                 Study  ... SeqLen
DRP006530 DRX198149 PMID:32865275 /  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  ...    NaN
          DRX198150 PMID:32865275 /  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  ...    NaN
          DRX198151 PMID:32865275 /  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  ...    NaN
          DRX198152 PMID:32865275 /                 en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  ...    NaN
          DRX198153 PMID:32865275 /                 en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  ...    NaN
          DRX198154 PMID:32865275 /                 en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  ...    NaN

[6 rows x 10 columns]

Conditions: ['non-cancer control', 'non-cancer control', 'non-cancer control', 'non-cancer control', 'non-cancer control', 'non-cancer control']
Batches: ['UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+', 'UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+', 'UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+', 'en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+', 'en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+', 'en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+']
</observation>
I see the issue! The sample_info is being read with the first column as index, so the conditions are not being parsed correctly. Let me fix this:

<execute>
import pandas as pd

# Load sample information without using first column as index
sample_info = pd.read_csv("benchmark/dataset/MetazExp/sample_info.tsv", sep="\t", index_col=False)
print("Sample info shape:", sample_info.shape)
print("Sample info columns:", sample_info.columns.tolist())
print("Sample info:")
print(sample_info)

# Create condition vector
conditions = []
for treatment in sample_info["TreatmentTreatment"]:
    if "cancer-bearing" in str(treatment):
        conditions.append("cancer-bearing")
    else:
        conditions.append("non-cancer control")

# Create batch vector (Study column)
batches = sample_info["Study"].tolist()

print("\nConditions:", conditions)
print("Batches:", batches)
</execute>
<observation>Sample info shape: (6, 10)
Sample info columns: ['Study', 'Experiment', 'Source', 'Strain', 'Genotype', 'DevelopmentDevelopment', 'Tissue', 'TreatmentTreatment', 'Mapped Bases', 'SeqLen']
Sample info:
       Study Experiment         Source  ...  TreatmentTreatment Mapped Bases SeqLen
0  DRP006530  DRX198149  PMID:32865275  ...      cancer-bearing      22.50GB  PE150
1  DRP006530  DRX198150  PMID:32865275  ...      cancer-bearing      23.76GB  PE150
2  DRP006530  DRX198151  PMID:32865275  ...      cancer-bearing      24.17GB  PE150
3  DRP006530  DRX198152  PMID:32865275  ...  non-cancer control      23.81GB  PE150
4  DRP006530  DRX198153  PMID:32865275  ...  non-cancer control      22.40GB  PE150
5  DRP006530  DRX198154  PMID:32865275  ...  non-cancer control      24.13GB  PE150

[6 rows x 10 columns]

Conditions: ['cancer-bearing', 'cancer-bearing', 'cancer-bearing', 'non-cancer control', 'non-cancer control', 'non-cancer control']
Batches: ['DRP006530', 'DRP006530', 'DRP006530', 'DRP006530', 'DRP006530', 'DRP006530']
</observation>
4. [✓] Load sample information

Perfect! Now I have:
- Conditions: 3 cancer-bearing, 3 non-cancer control
- Batches: All from the same study (DRP006530), so only one batch level

Since all samples are from the same study, the batch effect correction won't change much, but I'll still include it as requested.

Now I need to perform DESeq2 analysis. Since DESeq2 is an R package, I'll use R through subprocess or rpy2. Let me check if I can use R:

<execute>
import subprocess
import os
import pandas as pd
import numpy as np

# Save count matrix and sample info for R analysis
output_dir = "/root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate"

# Save count matrix
count_matrix_path = os.path.join(output_dir, "count_matrix.tsv")
count_matrix.to_csv(count_matrix_path, sep="\t")

# Create sample info dataframe for R
sample_df = pd.DataFrame({
    'sample': count_matrix.columns,
    'condition': conditions,
    'batch': batches
})
sample_info_path = os.path.join(output_dir, "sample_info_for_r.tsv")
sample_df.to_csv(sample_info_path, sep="\t", index=False)

print("Count matrix saved to:", count_matrix_path)
print("Sample info saved to:", sample_info_path)
print("Sample df:")
print(sample_df)
</execute>
<observation>NameError("name 'count_matrix' is not defined")</observation>
Let me recreate the count matrix and then save everything:

<execute>
import os
import pandas as pd

# Recreate count matrix
count_files = [
    "DRX198149.gene.expr.tsv",
    "DRX198150.gene.expr.tsv", 
    "DRX198151.gene.expr.tsv",
    "DRX198152.gene.expr.tsv",
    "DRX198153.gene.expr.tsv",
    "DRX198154.gene.expr.tsv"
]

count_dir = "benchmark/dataset/MetazExp/count"
count_data = {}

for file in count_files:
    sample_id = file.replace(".gene.expr.tsv", "")
    file_path = os.path.join(count_dir, file)
    df = pd.read_csv(file_path, sep="\t")
    count_data[sample_id] = df.set_index("geneId")["readCount"]

count_matrix = pd.DataFrame(count_data)

# Load sample information
sample_info = pd.read_csv("benchmark/dataset/MetazExp/sample_info.tsv", sep="\t", index_col=False)

# Create condition vector
conditions = []
for treatment in sample_info["TreatmentTreatment"]:
    if "cancer-bearing" in str(treatment):
        conditions.append("cancer-bearing")
    else:
        conditions.append("non-cancer control")

batches = sample_info["Study"].tolist()

# Save files for R analysis
output_dir = "/root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate"

count_matrix_path = os.path.join(output_dir, "count_matrix.tsv")
count_matrix.to_csv(count_matrix_path, sep="\t")

sample_df = pd.DataFrame({
    'sample': count_matrix.columns,
    'condition': conditions,
    'batch': batches
})
sample_info_path = os.path.join(output_dir, "sample_info_for_r.tsv")
sample_df.to_csv(sample_info_path, sep="\t", index=False)

print("Files prepared for R analysis")
print("Count matrix shape:", count_matrix.shape)
print("Sample info:")
print(sample_df)
</execute>
<observation>Files prepared for R analysis
Count matrix shape: (17714, 6)
Sample info:
      sample           condition      batch
0  DRX198149      cancer-bearing  DRP006530
1  DRX198150      cancer-bearing  DRP006530
2  DRX198151      cancer-bearing  DRP006530
3  DRX198152  non-cancer control  DRP006530
4  DRX198153  non-cancer control  DRP006530
5  DRX198154  non-cancer control  DRP006530
</observation>
5. [✓] Set up DESeq2 analysis with batch correction

Now I'll run the DESeq2 analysis using R:

<execute>
#!R
# Load required libraries
library(DESeq2)
library(tidyverse)

# Set working directory and file paths
output_dir <- "/root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate"
count_matrix_path <- file.path(output_dir, "count_matrix.tsv")
sample_info_path <- file.path(output_dir, "sample_info_for_r.tsv")

# Read data
count_data <- read.delim(count_matrix_path, row.names=1, check.names=FALSE)
sample_info <- read.delim(sample_info_path)

# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = count_data,
                              colData = sample_info,
                              design = ~ batch + condition)

# Filter out genes with zero counts across all samples
dds <- dds[rowSums(counts(dds)) > 0, ]

# Run DESeq2 pipeline
dds <- DESeq(dds)

# Get results comparing cancer-bearing vs non-cancer control
# Note: DESeq2 uses alphabetical order for reference level, so non-cancer control will be reference
res <- results(dds, contrast = c("condition", "cancer-bearing", "non-cancer control"))

# Order by adjusted p-value
res_ordered <- res[order(res$padj), ]

# Get top 50 significant genes (excluding NA p-values)
res_clean <- res_ordered[!is.na(res_ordered$padj), ]
top50 <- head(res_clean, 50)

# Add baseMean column if not present (it should be there from DESeq2 results)
# The results object already contains baseMean, log2FoldChange, lfcSE, stat, pvalue, padj

# Save results
output_file <- "/root/autodl-tmp/biomni_v20260208_pred_results/qwen3-max-2026-01-23/metazexp_annotate.tsv"
dir.create(dirname(output_file), recursive = TRUE, showWarnings = FALSE)
write.table(as.data.frame(top50), output_file, sep = "\t", quote = FALSE, row.names = TRUE)

print(paste("Top 50 results saved to:", output_file))
print(head(as.data.frame(top50)))
</execute>
<observation>Error running R code:
Loading required package: S4Vectors
Loading required package: stats4
Loading required package: BiocGenerics

Attaching package: ‘BiocGenerics’

The following objects are masked from ‘package:stats’:

    IQR, mad, sd, var, xtabs

The following objects are masked from ‘package:base’:

    anyDuplicated, aperm, append, as.data.frame, basename, cbind,
    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,
    get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply,
    match, mget, order, paste, pmax, pmax.int, pmin, pmin.int,
    Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort,
    table, tapply, union, unique, unsplit, which.max, which.min


Attaching package: ‘S4Vectors’

The following object is masked from ‘package:utils’:

    findMatches

The following objects are masked from ‘package:base’:

    expand.grid, I, unname

Loading required package: IRanges
Loading required package: GenomicRanges
Loading required package: GenomeInfoDb
Loading required package: SummarizedExperiment
Loading required package: MatrixGenerics
Loading required package: matrixStats

Attaching package: ‘MatrixGenerics’

The following objects are masked from ‘package:matrixStats’:

    colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,
    colCounts, colCummaxs, colCummins, colCumprods, colCumsums,
    colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,
    colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,
    colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,
    colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,
    colWeightedMeans, colWeightedMedians, colWeightedSds,
    colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,
    rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,
    rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,
    rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,
    rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,
    rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,
    rowWeightedMads, rowWeightedMeans, rowWeightedMedians,
    rowWeightedSds, rowWeightedVars

Loading required package: Biobase
Welcome to Bioconductor

    Vignettes contain introductory material; view with
    'browseVignettes()'. To cite Bioconductor, see
    'citation("Biobase")', and for packages 'citation("pkgname")'.


Attaching package: ‘Biobase’

The following object is masked from ‘package:MatrixGenerics’:

    rowMedians

The following objects are masked from ‘package:matrixStats’:

    anyMissing, rowMedians

── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.2
✔ ggplot2   3.5.2     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.1.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ lubridate::%within%() masks IRanges::%within%()
✖ dplyr::collapse()     masks IRanges::collapse()
✖ dplyr::combine()      masks Biobase::combine(), BiocGenerics::combine()
✖ dplyr::count()        masks matrixStats::count()
✖ dplyr::desc()         masks IRanges::desc()
✖ tidyr::expand()       masks S4Vectors::expand()
✖ dplyr::filter()       masks stats::filter()
✖ dplyr::first()        masks S4Vectors::first()
✖ dplyr::lag()          masks stats::lag()
✖ ggplot2::Position()   masks BiocGenerics::Position(), base::Position()
✖ purrr::reduce()       masks GenomicRanges::reduce(), IRanges::reduce()
✖ dplyr::rename()       masks S4Vectors::rename()
✖ lubridate::second()   masks S4Vectors::second()
✖ lubridate::second<-() masks S4Vectors::second<-()
✖ dplyr::slice()        masks IRanges::slice()
ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
Warning messages:
1: package ‘tidyverse’ was built under R version 4.3.3 
2: package ‘ggplot2’ was built under R version 4.3.3 
3: package ‘tibble’ was built under R version 4.3.3 
4: package ‘tidyr’ was built under R version 4.3.3 
5: package ‘readr’ was built under R version 4.3.3 
6: package ‘purrr’ was built under R version 4.3.3 
7: package ‘dplyr’ was built under R version 4.3.3 
8: package ‘stringr’ was built under R version 4.3.3 
9: package ‘forcats’ was built under R version 4.3.3 
10: package ‘lubridate’ was built under R version 4.3.3 
Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
  contrasts can be applied only to factors with 2 or more levels
Calls: DESeqDataSetFromMatrix -> DESeqDataSet -> <Anonymous> -> contrasts<-
In addition: Warning message:
In DESeqDataSet(se, design = design, ignoreRank) :
  some variables in design formula are characters, converting to factors
Execution halted
</observation>
The error occurs because the batch variable has only one level (all samples are from the same study DRP006530). DESeq2 can't handle factors with only one level in the design formula. Since there's no actual batch effect to correct for, I should just use the condition in the design formula.

However, the instruction specifically says to "explicitly correct for study-specific batch effects by including the batch variable in the design formula". But since all samples are from the same study, there's no batch variation to model.

Let me check if there are actually different studies or if I'm misinterpreting the data. Looking back at the sample_info, all rows have Study = "DRP006530", so indeed there's only one study.

In this case, I'll proceed with just the condition in the design formula, as including a single-level batch factor is not statistically valid.

<execute>
#!R
# Load required libraries
library(DESeq2)

# Set working directory and file paths
output_dir <- "/root/autodl-tmp/biomni_v20260208_tmp/qwen3-max-2026-01-23/metazexp_annotate"
count_matrix_path <- file.path(output_dir, "count_matrix.tsv")
sample_info_path <- file.path(output_dir, "sample_info_for_r.tsv")

# Read data
count_data <- read.delim(count_matrix_path, row.names=1, check.names=FALSE)
sample_info <- read.delim(sample_info_path)

# Since all samples are from the same study (batch), we can't include batch in design
# Just use condition in design formula
dds <- DESeqDataSetFromMatrix(countData = count_data,
                              colData = sample_info,
                              design = ~ condition)

# Filter out genes with zero counts across all samples
dds <- dds[rowSums(counts(dds)) > 0, ]

# Run DESeq2 pipeline
dds <- DESeq(dds)

# Get results comparing cancer-bearing vs non-cancer control
res <- results(dds, contrast = c("condition", "cancer-bearing", "non-cancer control"))

# Order by adjusted p-value
res_ordered <- res[order(res$padj), ]

# Get top 50 significant genes (excluding NA p-values)
res_clean <- res_ordered[!is.na(res_ordered$padj), ]
top50 <- head(res_clean, 50)

# Save results
output_file <- "/root/autodl-tmp/biomni_v20260208_pred_results/qwen3-max-2026-01-23/metazexp_annotate.tsv"
dir.create(dirname(output_file), recursive = TRUE, showWarnings = FALSE)
write.table(as.data.frame(top50), output_file, sep = "\t", quote = FALSE, row.names = TRUE)

print(paste("Top 50 results saved to:", output_file))
print(head(as.data.frame(top50)))
</execute>
<observation>[1] "Top 50 results saved to: /root/autodl-tmp/biomni_v20260208_pred_results/qwen3-max-2026-01-23/metazexp_annotate.tsv"
              baseMean log2FoldChange      lfcSE      stat        pvalue
FBgn0050098  2689.6667      -4.877729 0.17905045 -27.24220 2.055674e-163
FBgn0266429   694.5169      -6.730648 0.27602326 -24.38435 2.506555e-131
FBgn0032817 13116.4906      -2.070890 0.08743637 -23.68454 5.204646e-124
FBgn0000097  9797.8623      -1.137605 0.05783028 -19.67143  3.789099e-86
FBgn0019952 28155.9302      -1.283753 0.07144355 -17.96877  3.421950e-72
FBgn0030102  1928.7436       4.771585 0.26575833  17.95460  4.417433e-72
                     padj
FBgn0050098 3.319502e-159
FBgn0266429 2.023793e-127
FBgn0032817 2.801487e-120
FBgn0000097  1.529659e-82
FBgn0019952  1.105153e-68
FBgn0030102  1.188878e-68
</observation>
6. [✓] Run differential expression analysis
7. [✓] Extract top 50 significant genes
8. [✓] Save results to specified file

Perfect! The DESeq2 analysis completed successfully and the top 50 differentially expressed genes have been saved to the specified output file. Let me verify the output format:

<execute>
#!BASH
head -n 3 /root/autodl-tmp/biomni_v20260208_pred_results/qwen3-max-2026-01-23/metazexp_annotate.tsv
</execute>
<observation>baseMean	log2FoldChange	lfcSE	stat	pvalue	padj
FBgn0050098	2689.66665476386	-4.87772911936465	0.17905045247991	-27.2422049305457	2.05567383473253e-163	3.31950210832609e-159
FBgn0266429	694.516872705251	-6.730648430188	0.276023255336235	-24.3843527676287	2.50655533940541e-131	2.02379278103593e-127
</observation>
The output format looks correct! It contains the required columns: gene_id (as row names), baseMean, log2FoldChange, lfcSE, stat, pvalue, and padj.

Since all samples are from the same study (DRP006530), there was no actual batch effect to correct for. Including a single-level batch factor in the design formula would be statistically invalid, so I proceeded with just the condition variable as specified in the DESeq2 best practices.

The analysis successfully identified differentially expressed genes between cancer-bearing and non-cancer control conditions, with the top results showing highly significant p-values as expected.

<solution>
Differential expression analysis completed successfully. Top 50 significantly differentially expressed genes saved to /root/autodl-tmp/biomni_v20260208_pred_results/qwen3-max-2026-01-23/metazexp_annotate.tsv
</solution>