
Perform a differential expression analysis for 6 DRX experiments in `benchmark/dataset/MetazExp/count`. 

The basic information of the 6 DRX experiments is provided in `benchmark/dataset/MetazExp/sample_info.tsv`, which includes sample annotations specifying biological conditions (e.g., tissue, developmental stage) and study or batch identifiers.

You must explicitly correct for study-specific batch effects by including the batch variable in the design formula (e.g., design = ~ batch + condition).

Identify genes that are significantly differentially expressed in the target condition compared to all other conditions combined.

Output the top 50 most significantly differentially expressed genes (ranked by adjusted p-value) to `/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv`.

Output Format (Only for Reference):
gene_id	baseMean	log2FoldChange	lfcSE	stat	pvalue	padj
FBgnxxxx	1254.66665476386	-2.87772911936465	0.87905045247991	-27.2422049305457	2.05567383473253e-163	3.25310384346423e-159
FBgnyyyy	52136.516872705251	-4.730648430188	0.676023255336235	-24.3843527676287	2.50655533940541e-131	1.98331191230453e-127

All temp data should be save in `/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate`.

I'll help you perform a differential expression analysis for the 6 DRX experiments using DESeq2 with batch correction. Let me start by creating a plan and exploring the data.

**Plan:**
1. [ ] Explore the data structure (count files and sample_info.tsv)
2. [ ] Load and prepare the data for DESeq2
3. [ ] Create the DESeqDataSet with proper design formula (~ batch + condition)
4. [ ] Run DESeq2 differential expression analysis
5. [ ] Extract results and filter for significant genes
6. [ ] Output top 50 genes to the specified file
7. [ ] Save temp data to the specified directory

Let me start by exploring the data:

<execute>
# Check the data structure
import os
import pandas as pd

# Define paths
count_dir = "./benchmark/dataset/MetazExp/count"
sample_info_path = "./benchmark/dataset/MetazExp/sample_info.tsv"

# Check if paths exist
print("Checking paths...")
print(f"Count directory exists: {os.path.exists(count_dir)}")
print(f"Sample info exists: {os.path.exists(sample_info_path)}")

# List files in count directory
print(f"\nFiles in count directory:")
if os.path.exists(count_dir):
    files = os.listdir(count_dir)
    for f in files:
        print(f"  {f}")

# Read sample info
print(f"\nSample information:")
sample_info = pd.read_csv(sample_info_path, sep='\t')
print(sample_info)
print(f"\nShape: {sample_info.shape}")
print(f"\nColumns: {sample_info.columns.tolist()}")

# Check unique conditions and batches
if 'condition' in sample_info.columns:
    print(f"\nUnique conditions: {sample_info['condition'].unique()}")
if 'batch' in sample_info.columns:
    print(f"\nUnique batches: {sample_info['batch'].unique()}")
if 'study' in sample_info.columns:
    print(f"\nUnique studies: {sample_info['study'].unique()}")
</execute>
<observation>Checking paths...
Count directory exists: True
Sample info exists: True

Files in count directory:
  DRX198149.gene.expr.tsv
  DRX198150.gene.expr.tsv
  DRX198151.gene.expr.tsv
  DRX198152.gene.expr.tsv
  DRX198153.gene.expr.tsv
  DRX198154.gene.expr.tsv

Sample information:
                                                                                 Study  ... SeqLen
DRP006530 DRX198149 PMID:32865275 /  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  ...    NaN
          DRX198150 PMID:32865275 /  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  ...    NaN
          DRX198151 PMID:32865275 /  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  ...    NaN
          DRX198152 PMID:32865275 /                 en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  ...    NaN
          DRX198153 PMID:32865275 /                 en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  ...    NaN
          DRX198154 PMID:32865275 /                 en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  ...    NaN

[6 rows x 10 columns]

Shape: (6, 10)

Columns: ['Study', 'Experiment', 'Source', 'Strain', 'Genotype', 'DevelopmentDevelopment', 'Tissue', 'TreatmentTreatment', 'Mapped Bases', 'SeqLen']
</observation>
I see the structure now. Let me check the count file format and understand the condition and batch variables better:

<execute>
# Check one count file format
print("Checking count file format...")
first_count_file = os.path.join(count_dir, "DRX198149.gene.expr.tsv")
count_data = pd.read_csv(first_count_file, sep='\t')
print(f"Count file shape: {count_data.shape}")
print(f"First few rows:")
print(count_data.head())
print(f"\nColumns: {count_data.columns.tolist()}")

# Check sample info more carefully
print("\n" + "="*50)
print("Sample info detailed view:")
sample_info_reset = sample_info.reset_index()
print(sample_info_reset)
print(f"\nColumns: {sample_info_reset.columns.tolist()}")

# Check unique values in relevant columns
print("\n" + "="*50)
print("Unique values in each column:")
for col in sample_info_reset.columns:
    unique_vals = sample_info_reset[col].unique()
    print(f"\n{col}:")
    for val in unique_vals:
        print(f"  - {val}")

# Check if we can identify condition and batch
print("\n" + "="*50)
print("Identifying condition and batch variables:")
# It seems like Genotype might be the condition (different experimental conditions)
# And Study might be the batch (though they're all the same study here)
</execute>
<observation>NameError("name 'os' is not defined")</observation>
<execute>
import os
import pandas as pd

# Check one count file format
print("Checking count file format...")
first_count_file = os.path.join(count_dir, "DRX198149.gene.expr.tsv")
count_data = pd.read_csv(first_count_file, sep='\t')
print(f"Count file shape: {count_data.shape}")
print(f"First few rows:")
print(count_data.head())
print(f"\nColumns: {count_data.columns.tolist()}")

# Check sample info more carefully
print("\n" + "="*50)
print("Sample info detailed view:")
sample_info_reset = sample_info.reset_index()
print(sample_info_reset)
print(f"\nColumns: {sample_info_reset.columns.tolist()}")

# Check unique values in relevant columns
print("\n" + "="*50)
print("Unique values in each column:")
for col in sample_info_reset.columns:
    unique_vals = sample_info_reset[col].unique()
    print(f"\n{col}:")
    for val in unique_vals:
        print(f"  - {val}")

# Check if we can identify condition and batch
print("\n" + "="*50)
print("Identifying condition and batch variables:")
# It seems like Genotype might be the condition (different experimental conditions)
# And Study might be the batch (though they're all the same study here)
</execute>
<observation>NameError("name 'count_dir' is not defined")</observation>
<execute>
import os
import pandas as pd

# Define paths
count_dir = "./benchmark/dataset/MetazExp/count"
sample_info_path = "./benchmark/dataset/MetazExp/sample_info.tsv"

# Check one count file format
print("Checking count file format...")
first_count_file = os.path.join(count_dir, "DRX198149.gene.expr.tsv")
count_data = pd.read_csv(first_count_file, sep='\t')
print(f"Count file shape: {count_data.shape}")
print(f"First few rows:")
print(count_data.head())
print(f"\nColumns: {count_data.columns.tolist()}")

# Check sample info more carefully
print("\n" + "="*50)
print("Sample info detailed view:")
sample_info = pd.read_csv(sample_info_path, sep='\t')
sample_info_reset = sample_info.reset_index()
print(sample_info_reset)
print(f"\nColumns: {sample_info_reset.columns.tolist()}")

# Check unique values in relevant columns
print("\n" + "="*50)
print("Unique values in each column:")
for col in sample_info_reset.columns:
    unique_vals = sample_info_reset[col].unique()
    print(f"\n{col}:")
    for val in unique_vals:
        print(f"  - {val}")

# Check if we can identify condition and batch
print("\n" + "="*50)
print("Identifying condition and batch variables:")
# It seems like Genotype might be the condition (different experimental conditions)
# And Study might be the batch (though they're all the same study here)
</execute>
<observation>Checking count file format...
Count file shape: (17714, 5)
First few rows:
        geneId  readCount     Coverage        FPKM         TPM
0  FBgn0039635      20831  1530.846436  105.496330  161.640015
1  FBgn0086355      28769  2769.733643  150.103287  229.986176
2  FBgn0034501      17799   682.803040   31.329226   48.002205
3  FBgn0051774         31     0.599920    0.028744    0.044041
4  FBgn0011603       1835    52.291134    3.254867    4.987062

Columns: ['geneId', 'readCount', 'Coverage', 'FPKM', 'TPM']

==================================================
Sample info detailed view:
     level_0    level_1  ... Mapped Bases SeqLen
0  DRP006530  DRX198149  ...          NaN    NaN
1  DRP006530  DRX198150  ...          NaN    NaN
2  DRP006530  DRX198151  ...          NaN    NaN
3  DRP006530  DRX198152  ...          NaN    NaN
4  DRP006530  DRX198153  ...          NaN    NaN
5  DRP006530  DRX198154  ...          NaN    NaN

[6 rows x 14 columns]

Columns: ['level_0', 'level_1', 'level_2', 'level_3', 'Study', 'Experiment', 'Source', 'Strain', 'Genotype', 'DevelopmentDevelopment', 'Tissue', 'TreatmentTreatment', 'Mapped Bases', 'SeqLen']

==================================================
Unique values in each column:

level_0:
  - DRP006530

level_1:
  - DRX198149
  - DRX198150
  - DRX198151
  - DRX198152
  - DRX198153
  - DRX198154

level_2:
  - PMID:32865275

level_3:
  - /

Study:
  - UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+
  - en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+

Experiment:
  - L3

Source:
  - hemocyte

Strain:
  - cancer-bearing
  - non-cancer control

Genotype:
  - 22.50GB
  - 23.76GB
  - 24.17GB
  - 23.81GB
  - 22.40GB
  - 24.13GB

DevelopmentDevelopment:
  - PE150

Tissue:
  - nan

TreatmentTreatment:
  - nan

Mapped Bases:
  - nan

SeqLen:
  - nan

==================================================
Identifying condition and batch variables:
</observation>
Now I understand the data structure. Let me verify the mapping of samples to conditions and batches:

<execute>
# Create a clearer mapping
sample_info_reset = sample_info.reset_index()
print("Sample mapping:")
print(sample_info_reset[['level_1', 'Study', 'Strain', 'Genotype']])

# Count samples per condition
print("\n" + "="*50)
print("Samples per Strain (condition):")
print(sample_info_reset['Strain'].value_counts())

print("\n" + "="*50)
print("Samples per Study (batch):")
print(sample_info_reset['Study'].value_counts())

# Check which samples have which strain
print("\n" + "="*50)
print("Detailed sample-strain mapping:")
for idx, row in sample_info_reset.iterrows():
    print(f"{row['level_1']}: Strain={row['Strain']}, Study={row['Study']}")
</execute>
<observation>NameError("name 'sample_info' is not defined")</observation>
<execute>
import os
import pandas as pd

# Define paths
count_dir = "./benchmark/dataset/MetazExp/count"
sample_info_path = "./benchmark/dataset/MetazExp/sample_info.tsv"

# Load sample info
sample_info = pd.read_csv(sample_info_path, sep='\t')

# Create a clearer mapping
sample_info_reset = sample_info.reset_index()
print("Sample mapping:")
print(sample_info_reset[['level_1', 'Study', 'Strain', 'Genotype']])

# Count samples per condition
print("\n" + "="*50)
print("Samples per Strain (condition):")
print(sample_info_reset['Strain'].value_counts())

print("\n" + "="*50)
print("Samples per Study (batch):")
print(sample_info_reset['Study'].value_counts())

# Check which samples have which strain
print("\n" + "="*50)
print("Detailed sample-strain mapping:")
for idx, row in sample_info_reset.iterrows():
    print(f"{row['level_1']}: Strain={row['Strain']}, Study={row['Study']}")
</execute>
<observation>Sample mapping:
     level_1  ... Genotype
0  DRX198149  ...  22.50GB
1  DRX198150  ...  23.76GB
2  DRX198151  ...  24.17GB
3  DRX198152  ...  23.81GB
4  DRX198153  ...  22.40GB
5  DRX198154  ...  24.13GB

[6 rows x 4 columns]

==================================================
Samples per Strain (condition):
Strain
cancer-bearing        3
non-cancer control    3
Name: count, dtype: int64

==================================================
Samples per Study (batch):
Study
UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+    3
en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+                   3
Name: count, dtype: int64

==================================================
Detailed sample-strain mapping:
DRX198149: Strain=cancer-bearing, Study=UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+
DRX198150: Strain=cancer-bearing, Study=UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+
DRX198151: Strain=cancer-bearing, Study=UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+
DRX198152: Strain=non-cancer control, Study=en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+
DRX198153: Strain=non-cancer control, Study=en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+
DRX198154: Strain=non-cancer control, Study=en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+
</observation>
Perfect! Now I understand the structure. I can see:
- **Condition**: "cancer-bearing" (3 samples) vs "non-cancer control" (3 samples)
- **Batch**: Two different Study batches (3 samples each)

Note: There's a confounding between condition and batch (all cancer-bearing samples are in one batch), but I'll proceed with the analysis as instructed.

Now let me prepare the count matrix and run DESeq2:

<execute>
import os
import pandas as pd
import subprocess

# Define paths
count_dir = "./benchmark/dataset/MetazExp/count"
sample_info_path = "./benchmark/dataset/MetazExp/sample_info.tsv"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7"
temp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate"

# Create directories
os.makedirs(output_dir, exist_ok=True)
os.makedirs(temp_dir, exist_ok=True)

print("Step 1: Loading and merging count files...")

# Load sample info
sample_info = pd.read_csv(sample_info_path, sep='\t')
sample_info_reset = sample_info.reset_index()

# Get sample names
sample_names = sample_info_reset['level_1'].tolist()
print(f"Samples: {sample_names}")

# Load count files and merge
count_dfs = []
for sample in sample_names:
    count_file = os.path.join(count_dir, f"{sample}.gene.expr.tsv")
    df = pd.read_csv(count_file, sep='\t')
    count_dfs.append(df[['geneId', 'readCount']].rename(columns={'readCount': sample}))

# Merge all count data
count_matrix = count_dfs[0]
for df in count_dfs[1:]:
    count_matrix = count_matrix.merge(df, on='geneId', how='outer')

print(f"Count matrix shape: {count_matrix.shape}")
print(f"First few rows of count matrix:")
print(count_matrix.head())

# Save count matrix for R
count_matrix_path = os.path.join(temp_dir, "count_matrix.tsv")
count_matrix.to_csv(count_matrix_path, sep='\t', index=False)
print(f"\nCount matrix saved to: {count_matrix_path}")

# Prepare sample metadata
metadata = sample_info_reset[['level_1', 'Study', 'Strain']].copy()
metadata.columns = ['sample', 'batch', 'condition']
metadata_path = os.path.join(temp_dir, "metadata.tsv")
metadata.to_csv(metadata_path, sep='\t', index=False)
print(f"Metadata saved to: {metadata_path}")
print("\nMetadata:")
print(metadata)

print("\n" + "="*50)
print("Data preparation complete!")
</execute>
<observation>Step 1: Loading and merging count files...
Samples: ['DRX198149', 'DRX198150', 'DRX198151', 'DRX198152', 'DRX198153', 'DRX198154']
Count matrix shape: (17714, 7)
First few rows of count matrix:
        geneId  DRX198149  DRX198150  ...  DRX198152  DRX198153  DRX198154
0  FBgn0000003       1511       1992  ...        386       5597       2064
1  FBgn0000008       2577       2747  ...       5381       2719       3226
2  FBgn0000014       1273        994  ...       2563        939        960
3  FBgn0000015       1565         78  ...         93        111         85
4  FBgn0000017       9798      10853  ...      15360      17951      20272

[5 rows x 7 columns]

Count matrix saved to: /root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/count_matrix.tsv
Metadata saved to: /root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/metadata.tsv

Metadata:
      sample  ...           condition
0  DRX198149  ...      cancer-bearing
1  DRX198150  ...      cancer-bearing
2  DRX198151  ...      cancer-bearing
3  DRX198152  ...  non-cancer control
4  DRX198153  ...  non-cancer control
5  DRX198154  ...  non-cancer control

[6 rows x 3 columns]

==================================================
Data preparation complete!
</observation>
Now let me run DESeq2 with R to perform the differential expression analysis:

<execute>
# Create and run R script for DESeq2 analysis
r_script = """
# Load libraries
library(DESeq2)
library(data.table)

# Read data
count_matrix <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/count_matrix.tsv', sep='\\t', header=TRUE)
metadata <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/metadata.tsv', sep='\\t', header=TRUE)

# Prepare count matrix (remove geneId column)
counts <- as.matrix(count_matrix[, -1, with=FALSE])
rownames(counts) <- count_matrix$geneId

# Prepare colData
coldata <- data.frame(
  row.names = metadata$sample,
  batch = metadata$batch,
  condition = metadata$condition
)

# Print dimensions
cat("Count matrix dimensions:", nrow(counts), "x", ncol(counts), "\\n")
cat("Metadata dimensions:", nrow(coldata), "x", ncol(coldata), "\\n")
cat("Conditions:", unique(coldata$condition), "\\n")
cat("Batches:", unique(coldata$batch), "\\n")

# Create DESeqDataSet with design ~ batch + condition
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = coldata,
                              design = ~ batch + condition)

# Pre-filter low count genes
keep <- rowSums(counts(dds) >= 10) >= 3
dds <- dds[keep,]
cat("After pre-filtering:", nrow(dds), "genes\\n")

# Run DESeq
dds <- DESeq(dds)

# Get results comparing cancer-bearing vs non-cancer control
res <- results(dds, contrast = c("condition", "cancer-bearing", "non-cancer control"))
res <- as.data.frame(res)

# Add gene_id column
res$gene_id <- rownames(res)

# Reorder columns
res <- res[, c("gene_id", "baseMean", "log2FoldChange", "lfcSE", "stat", "pvalue", "padj")]

# Sort by adjusted p-value
res <- res[order(res$padj), ]

# Get top 50 genes
top50 <- head(res, 50)

# Save results
output_path <- '/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv'
fwrite(top50, output_path, sep='\\t', quote=FALSE)
cat("Top 50 DE genes saved to:", output_path, "\\n")

# Print summary
cat("\\nSummary of results:\\n")
cat("Total genes tested:", nrow(res), "\\n")
cat("Significant genes (padj < 0.05):", sum(res$padj < 0.05, na.rm=TRUE), "\\n")
cat("Significant genes (padj < 0.01):", sum(res$padj < 0.01, na.rm=TRUE), "\\n")

# Print top 10
cat("\\nTop 10 genes:\\n")
print(head(top50, 10))
"""

# Save R script
r_script_path = os.path.join(temp_dir, "deseq2_analysis.R")
with open(r_script_path, 'w') as f:
    f.write(r_script)

print("Running DESeq2 analysis...")
result = subprocess.run(['Rscript', r_script_path], capture_output=True, text=True)
print(result.stdout)
if result.stderr:
    print("STDERR:", result.stderr)
print(f"Return code: {result.returncode}")
</execute>
<observation>NameError("name 'os' is not defined")</observation>
<execute>
import os
import subprocess

# Create and run R script for DESeq2 analysis
r_script = """
# Load libraries
library(DESeq2)
library(data.table)

# Read data
count_matrix <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/count_matrix.tsv', sep='\\t', header=TRUE)
metadata <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/metadata.tsv', sep='\\t', header=TRUE)

# Prepare count matrix (remove geneId column)
counts <- as.matrix(count_matrix[, -1, with=FALSE])
rownames(counts) <- count_matrix$geneId

# Prepare colData
coldata <- data.frame(
  row.names = metadata$sample,
  batch = metadata$batch,
  condition = metadata$condition
)

# Print dimensions
cat("Count matrix dimensions:", nrow(counts), "x", ncol(counts), "\\n")
cat("Metadata dimensions:", nrow(coldata), "x", ncol(coldata), "\\n")
cat("Conditions:", unique(coldata$condition), "\\n")
cat("Batches:", unique(coldata$batch), "\\n")

# Create DESeqDataSet with design ~ batch + condition
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = coldata,
                              design = ~ batch + condition)

# Pre-filter low count genes
keep <- rowSums(counts(dds) >= 10) >= 3
dds <- dds[keep,]
cat("After pre-filtering:", nrow(dds), "genes\\n")

# Run DESeq
dds <- DESeq(dds)

# Get results comparing cancer-bearing vs non-cancer control
res <- results(dds, contrast = c("condition", "cancer-bearing", "non-cancer control"))
res <- as.data.frame(res)

# Add gene_id column
res$gene_id <- rownames(res)

# Reorder columns
res <- res[, c("gene_id", "baseMean", "log2FoldChange", "lfcSE", "stat", "pvalue", "padj")]

# Sort by adjusted p-value
res <- res[order(res$padj), ]

# Get top 50 genes
top50 <- head(res, 50)

# Save results
output_path <- '/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv'
fwrite(top50, output_path, sep='\\t', quote=FALSE)
cat("Top 50 DE genes saved to:", output_path, "\\n")

# Print summary
cat("\\nSummary of results:\\n")
cat("Total genes tested:", nrow(res), "\\n")
cat("Significant genes (padj < 0.05):", sum(res$padj < 0.05, na.rm=TRUE), "\\n")
cat("Significant genes (padj < 0.01):", sum(res$padj < 0.01, na.rm=TRUE), "\\n")

# Print top 10
cat("\\nTop 10 genes:\\n")
print(head(top50, 10))
"""

# Save R script
temp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate"
r_script_path = os.path.join(temp_dir, "deseq2_analysis.R")
with open(r_script_path, 'w') as f:
    f.write(r_script)

print("Running DESeq2 analysis...")
result = subprocess.run(['Rscript', r_script_path], capture_output=True, text=True)
print(result.stdout)
if result.stderr:
    print("STDERR:", result.stderr)
print(f"Return code: {result.returncode}")
</execute>
<observation>Running DESeq2 analysis...
Count matrix dimensions: 17714 x 6 
Metadata dimensions: 6 x 2 
Conditions: cancer-bearing non-cancer control 
Batches: UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+ en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+ 

STDERR: Loading required package: S4Vectors
Loading required package: stats4
Loading required package: BiocGenerics

Attaching package: ‘BiocGenerics’

The following objects are masked from ‘package:stats’:

    IQR, mad, sd, var, xtabs

The following objects are masked from ‘package:base’:

    anyDuplicated, aperm, append, as.data.frame, basename, cbind,
    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,
    get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply,
    match, mget, order, paste, pmax, pmax.int, pmin, pmin.int,
    Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort,
    table, tapply, union, unique, unsplit, which.max, which.min


Attaching package: ‘S4Vectors’

The following object is masked from ‘package:utils’:

    findMatches

The following objects are masked from ‘package:base’:

    expand.grid, I, unname

Loading required package: IRanges
Loading required package: GenomicRanges
Loading required package: GenomeInfoDb
Loading required package: SummarizedExperiment
Loading required package: MatrixGenerics
Loading required package: matrixStats

Attaching package: ‘MatrixGenerics’

The following objects are masked from ‘package:matrixStats’:

    colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,
    colCounts, colCummaxs, colCummins, colCumprods, colCumsums,
    colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,
    colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,
    colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,
    colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,
    colWeightedMeans, colWeightedMedians, colWeightedSds,
    colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,
    rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,
    rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,
    rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,
    rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,
    rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,
    rowWeightedMads, rowWeightedMeans, rowWeightedMedians,
    rowWeightedSds, rowWeightedVars

Loading required package: Biobase
Welcome to Bioconductor

    Vignettes contain introductory material; view with
    'browseVignettes()'. To cite Bioconductor, see
    'citation("Biobase")', and for packages 'citation("pkgname")'.


Attaching package: ‘Biobase’

The following object is masked from ‘package:MatrixGenerics’:

    rowMedians

The following objects are masked from ‘package:matrixStats’:

    anyMissing, rowMedians


Attaching package: ‘data.table’

The following object is masked from ‘package:SummarizedExperiment’:

    shift

The following object is masked from ‘package:GenomicRanges’:

    shift

The following object is masked from ‘package:IRanges’:

    shift

The following objects are masked from ‘package:S4Vectors’:

    first, second

Warning message:
package ‘data.table’ was built under R version 4.3.3 
Error in checkFullRank(modelMatrix) : 
  the model matrix is not full rank, so the model cannot be fit as specified.
  One or more variables or interaction terms in the design formula are linear
  combinations of the others and must be removed.

  Please read the vignette section 'Model matrix not full rank':

  vignette('DESeq2')
Calls: DESeqDataSetFromMatrix -> DESeqDataSet -> checkFullRank
In addition: Warning message:
In DESeqDataSet(se, design = design, ignoreRank) :
  some variables in design formula are characters, converting to factors
Execution halted

Return code: 1
</observation>
I see the issue - there's perfect confounding between batch and condition (all cancer-bearing samples are in one batch, all non-cancer control samples are in the other). This makes the model matrix not full rank.

Let me check the data structure again and try an alternative approach:

<execute>
import os
import pandas as pd

# Load metadata
temp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate"
metadata = pd.read_csv(os.path.join(temp_dir, "metadata.tsv"), sep='\t')

print("Metadata structure:")
print(metadata)

print("\n" + "="*50)
print("Checking confounding:")
print("Cancer-bearing samples:")
cancer_samples = metadata[metadata['condition'] == 'cancer-bearing']
print(cancer_samples[['sample', 'batch', 'condition']])

print("\nNon-cancer control samples:")
control_samples = metadata[metadata['condition'] == 'non-cancer control']
print(control_samples[['sample', 'batch', 'condition']])

print("\n" + "="*50)
print("Cross-tabulation of batch vs condition:")
print(pd.crosstab(metadata['batch'], metadata['condition']))
</execute>
<observation>Metadata structure:
      sample  ...           condition
0  DRX198149  ...      cancer-bearing
1  DRX198150  ...      cancer-bearing
2  DRX198151  ...      cancer-bearing
3  DRX198152  ...  non-cancer control
4  DRX198153  ...  non-cancer control
5  DRX198154  ...  non-cancer control

[6 rows x 3 columns]

==================================================
Checking confounding:
Cancer-bearing samples:
      sample                                              batch       condition
0  DRX198149  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  cancer-bearing
1  DRX198150  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  cancer-bearing
2  DRX198151  UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+  cancer-bearing

Non-cancer control samples:
      sample                               batch           condition
3  DRX198152  en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  non-cancer control
4  DRX198153  en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  non-cancer control
5  DRX198154  en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+  non-cancer control

==================================================
Cross-tabulation of batch vs condition:
condition                                          cancer-bearing  non-cancer control
batch                                                                                
UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+               3                   0
en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+                              0                   3
</observation>
I see the issue - there's perfect confounding between batch and condition in this dataset. This is a common problem in small experimental designs. Let me try an alternative approach using a combined batch+condition design or using limma-voom which can handle this better:

<execute>
import os
import subprocess

# Try using limma-voom which can handle this design better
r_script = """
# Load libraries
library(limma)
library(edgeR)
library(data.table)

# Read data
count_matrix <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/count_matrix.tsv', sep='\\t', header=TRUE)
metadata <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/metadata.tsv', sep='\\t', header=TRUE)

# Prepare count matrix (remove geneId column)
counts <- as.matrix(count_matrix[, -1, with=FALSE])
rownames(counts) <- count_matrix$geneId

# Prepare colData
coldata <- data.frame(
  row.names = metadata$sample,
  batch = metadata$batch,
  condition = metadata$condition
)

# Print dimensions
cat("Count matrix dimensions:", nrow(counts), "x", ncol(counts), "\\n")
cat("Metadata dimensions:", nrow(coldata), "x", ncol(coldata), "\\n")
cat("Conditions:", unique(coldata$condition), "\\n")
cat("Batches:", unique(coldata$batch), "\\n")

# Create DGEList
dge <- DGEList(counts=counts)

# Filter low expressed genes
keep <- filterByExpr(dge, group=coldata$condition)
dge <- dge[keep,,keep.lib.sizes=FALSE]
cat("After filtering:", nrow(dge), "genes\\n")

# Normalize
dge <- calcNormFactors(dge)

# Create design matrix
# Since batch and condition are confounded, we'll use a combined approach
# We'll create a design with condition and try to account for batch effects
design <- model.matrix(~ 0 + condition, data=coldata)
colnames(design) <- c("cancer", "control")
cat("\\nDesign matrix:\\n")
print(design)

# Estimate dispersion
dge <- estimateDisp(dge, design)

# Fit model
fit <- glmFit(dge, design)

# Make contrast: cancer vs control
contrast <- makeContrasts(cancer - control, levels=design)
fit2 <- glmLRT(fit, contrast=contrast)

# Get results
res <- topTags(fit2, n=Inf)$table
res$gene_id <- rownames(res)

# Calculate adjusted p-values (Benjamini-Hochberg)
res$padj <- p.adjust(res$PValue, method="BH")

# Reorder columns to match expected format
res <- res[, c("gene_id", "logCPM", "logFC", "PValue", "padj")]

# Rename columns to match expected output
colnames(res) <- c("gene_id", "baseMean", "log2FoldChange", "pvalue", "padj")

# Add lfcSE and stat columns (approximate)
res$lfcSE <- NA
res$stat <- NA

# Reorder to match expected format exactly
res <- res[, c("gene_id", "baseMean", "log2FoldChange", "lfcSE", "stat", "pvalue", "padj")]

# Sort by adjusted p-value
res <- res[order(res$padj), ]

# Get top 50 genes
top50 <- head(res, 50)

# Save results
output_path <- '/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv'
write.table(top50, output_path, sep='\\t', quote=FALSE, row.names=FALSE)
cat("Top 50 DE genes saved to:", output_path, "\\n")

# Print summary
cat("\\nSummary of results:\\n")
cat("Total genes tested:", nrow(res), "\\n")
cat("Significant genes (padj < 0.05):", sum(res$padj < 0.05, na.rm=TRUE), "\\n")
cat("Significant genes (padj < 0.01):", sum(res$padj < 0.01, na.rm=TRUE), "\\n")

# Print top 10
cat("\\nTop 10 genes:\\n")
print(head(top50, 10))
"""

# Save R script
temp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate"
r_script_path = os.path.join(temp_dir, "limma_analysis.R")
with open(r_script_path, 'w') as f:
    f.write(r_script)

print("Running limma-voom analysis...")
result = subprocess.run(['Rscript', r_script_path], capture_output=True, text=True)
print(result.stdout)
if result.stderr:
    print("STDERR:", result.stderr)
print(f"Return code: {result.returncode}")
</execute>
<observation>Running limma-voom analysis...

STDERR: Error in library(edgeR) : there is no package called ‘edgeR’
Execution halted

Return code: 1
</observation>
Let me try DESeq2 with a simpler design (just condition) since batch and condition are perfectly confounded:

<execute>
import os
import subprocess

# Run DESeq2 with simple design (just condition)
r_script = """
# Load libraries
library(DESeq2)
library(data.table)

# Read data
count_matrix <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/count_matrix.tsv', sep='\\t', header=TRUE)
metadata <- fread('/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate/metadata.tsv', sep='\\t', header=TRUE)

# Prepare count matrix (remove geneId column)
counts <- as.matrix(count_matrix[, -1, with=FALSE])
rownames(counts) <- count_matrix$geneId

# Prepare colData
coldata <- data.frame(
  row.names = metadata$sample,
  batch = metadata$batch,
  condition = metadata$condition
)

# Print dimensions
cat("Count matrix dimensions:", nrow(counts), "x", ncol(counts), "\\n")
cat("Metadata dimensions:", nrow(coldata), "x", ncol(coldata), "\\n")
cat("Conditions:", unique(coldata$condition), "\\n")
cat("Batches:", unique(coldata$batch), "\\n")

# NOTE: Since batch and condition are perfectly confounded (all cancer samples are in batch 1,
# all control samples are in batch 2), we cannot include both in the model.
# We'll use design = ~ condition only.

# Create DESeqDataSet with design ~ condition
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = coldata,
                              design = ~ condition)

# Pre-filter low count genes
keep <- rowSums(counts(dds) >= 10) >= 3
dds <- dds[keep,]
cat("After pre-filtering:", nrow(dds), "genes\\n")

# Run DESeq
dds <- DESeq(dds)

# Get results comparing cancer-bearing vs non-cancer control
res <- results(dds, contrast = c("condition", "cancer-bearing", "non-cancer control"))
res <- as.data.frame(res)

# Add gene_id column
res$gene_id <- rownames(res)

# Reorder columns
res <- res[, c("gene_id", "baseMean", "log2FoldChange", "lfcSE", "stat", "pvalue", "padj")]

# Sort by adjusted p-value
res <- res[order(res$padj), ]

# Get top 50 genes
top50 <- head(res, 50)

# Save results
output_path <- '/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv'
fwrite(top50, output_path, sep='\\t', quote=FALSE)
cat("Top 50 DE genes saved to:", output_path, "\\n")

# Print summary
cat("\\nSummary of results:\\n")
cat("Total genes tested:", nrow(res), "\\n")
cat("Significant genes (padj < 0.05):", sum(res$padj < 0.05, na.rm=TRUE), "\\n")
cat("Significant genes (padj < 0.01):", sum(res$padj < 0.01, na.rm=TRUE), "\\n")

# Print top 10
cat("\\nTop 10 genes:\\n")
print(head(top50, 10))
"""

# Save R script
temp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate"
r_script_path = os.path.join(temp_dir, "deseq2_simple_analysis.R")
with open(r_script_path, 'w') as f:
    f.write(r_script)

print("Running DESeq2 analysis with simple design (condition only)...")
result = subprocess.run(['Rscript', r_script_path], capture_output=True, text=True)
print(result.stdout)
if result.stderr:
    print("STDERR:", result.stderr)
print(f"Return code: {result.returncode}")
</execute>
<observation>Running DESeq2 analysis with simple design (condition only)...
Count matrix dimensions: 17714 x 6 
Metadata dimensions: 6 x 2 
Conditions: cancer-bearing non-cancer control 
Batches: UAS-bub3IR...UAS-bub3IR/en-GAL4 UAS-GFP;UAS-p35/+ en-GAL4 UA...en-GAL4 UAS-GFP/+;+/+ 
After pre-filtering: 14339 genes
Top 50 DE genes saved to: /root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv 

Summary of results:
Total genes tested: 14339 
Significant genes (padj < 0.05): 9139 
Significant genes (padj < 0.01): 8045 

Top 10 genes:
                gene_id   baseMean log2FoldChange      lfcSE      stat
FBgn0050098 FBgn0050098  2700.9862      -4.892251 0.17846177 -27.41344
FBgn0032817 FBgn0032817 13149.5478      -2.085269 0.08359327 -24.94542
FBgn0266429 FBgn0266429   697.5042      -6.744930 0.27519483 -24.50965
FBgn0000097 FBgn0000097  9810.8183      -1.152030 0.05199307 -22.15738
FBgn0019952 FBgn0019952 28198.1217      -1.298188 0.06503779 -19.96052
FBgn0000566 FBgn0000566 29547.6374      -1.158091 0.06061119 -19.10689
FBgn0036571 FBgn0036571  6544.7474      -1.041154 0.05491905 -18.95797
FBgn0036846 FBgn0036846  6260.6858      -1.192012 0.06661371 -17.89440
FBgn0030102 FBgn0030102  1918.8045       4.757613 0.26728422  17.79983
FBgn0037612 FBgn0037612  6571.7999      -2.015889 0.11358230 -17.74826
                   pvalue          padj
FBgn0050098 1.896520e-165 2.715058e-161
FBgn0032817 2.394207e-137 1.713773e-133
FBgn0266429 1.165472e-132 5.561632e-129
FBgn0000097 8.854787e-109 3.169128e-105
FBgn0019952  1.214423e-88  3.477136e-85
FBgn0000566  2.212741e-81  5.279601e-78
FBgn0036571  3.794916e-80  7.761145e-77
FBgn0036846  1.303967e-71  2.333450e-68
FBgn0030102  7.088463e-71  1.127538e-67
FBgn0037612  1.777633e-70  2.544860e-67

STDERR: Loading required package: S4Vectors
Loading required package: stats4
Loading required package: BiocGenerics

Attaching package: ‘BiocGenerics’

The following objects are masked from ‘package:stats’:

    IQR, mad, sd, var, xtabs

The following objects are masked from ‘package:base’:

    anyDuplicated, aperm, append, as.data.frame, basename, cbind,
    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,
    get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply,
    match, mget, order, paste, pmax, pmax.int, pmin, pmin.int,
    Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort,
    table, tapply, union, unique, unsplit, which.max, which.min


Attaching package: ‘S4Vectors’

The following object is masked from ‘package:utils’:

    findMatches

The following objects are masked from ‘package:base’:

    expand.grid, I, unname

Loading required package: IRanges
Loading required package: GenomicRanges
Loading required package: GenomeInfoDb
Loading required package: SummarizedExperiment
Loading required package: MatrixGenerics
Loading required package: matrixStats

Attaching package: ‘MatrixGenerics’

The following objects are masked from ‘package:matrixStats’:

    colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,
    colCounts, colCummaxs, colCummins, colCumprods, colCumsums,
    colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,
    colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,
    colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,
    colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,
    colWeightedMeans, colWeightedMedians, colWeightedSds,
    colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,
    rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,
    rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,
    rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,
    rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,
    rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,
    rowWeightedMads, rowWeightedMeans, rowWeightedMedians,
    rowWeightedSds, rowWeightedVars

Loading required package: Biobase
Welcome to Bioconductor

    Vignettes contain introductory material; view with
    'browseVignettes()'. To cite Bioconductor, see
    'citation("Biobase")', and for packages 'citation("pkgname")'.


Attaching package: ‘Biobase’

The following object is masked from ‘package:MatrixGenerics’:

    rowMedians

The following objects are masked from ‘package:matrixStats’:

    anyMissing, rowMedians


Attaching package: ‘data.table’

The following object is masked from ‘package:SummarizedExperiment’:

    shift

The following object is masked from ‘package:GenomicRanges’:

    shift

The following object is masked from ‘package:IRanges’:

    shift

The following objects are masked from ‘package:S4Vectors’:

    first, second

Warning message:
package ‘data.table’ was built under R version 4.3.3 
  Note: levels of factors in the design contain characters other than
  letters, numbers, '_' and '.'. It is recommended (but not required) to use
  only letters, numbers, and delimiters '_' or '.', as these are safe characters
  for column names in R. [This is a message, not a warning or an error]
Warning message:
In DESeqDataSet(se, design = design, ignoreRank) :
  some variables in design formula are characters, converting to factors
estimating size factors
  Note: levels of factors in the design contain characters other than
  letters, numbers, '_' and '.'. It is recommended (but not required) to use
  only letters, numbers, and delimiters '_' or '.', as these are safe characters
  for column names in R. [This is a message, not a warning or an error]
estimating dispersions
gene-wise dispersion estimates
mean-dispersion relationship
  Note: levels of factors in the design contain characters other than
  letters, numbers, '_' and '.'. It is recommended (but not required) to use
  only letters, numbers, and delimiters '_' or '.', as these are safe characters
  for column names in R. [This is a message, not a warning or an error]
final dispersion estimates
fitting model and testing

Return code: 0
</observation>
The DESeq2 analysis completed successfully! Let me verify the output file:

<execute>
import os
import pandas as pd

# Check the output file
output_path = "/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv"

if os.path.exists(output_path):
    print("Output file created successfully!")
    print(f"File path: {output_path}")
    
    # Read and display the results
    results = pd.read_csv(output_path, sep='\t')
    print(f"\nNumber of genes in output: {len(results)}")
    print("\nFirst 10 genes:")
    print(results.head(10))
    
    print("\n" + "="*50)
    print("Column names:")
    print(results.columns.tolist())
    
    print("\n" + "="*50)
    print("Summary statistics:")
    print(f"Mean log2FoldChange: {results['log2FoldChange'].mean():.4f}")
    print(f"Min padj: {results['padj'].min():.2e}")
    print(f"Max padj: {results['padj'].max():.2e}")
else:
    print("ERROR: Output file not found!")
</execute>
<observation>Output file created successfully!
File path: /root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv

Number of genes in output: 50

First 10 genes:
       gene_id      baseMean  ...         pvalue           padj
0  FBgn0050098   2700.986164  ...  1.896520e-165  2.715058e-161
1  FBgn0032817  13149.547773  ...  2.394207e-137  1.713773e-133
2  FBgn0266429    697.504212  ...  1.165472e-132  5.561632e-129
3  FBgn0000097   9810.818327  ...  8.854787e-109  3.169128e-105
4  FBgn0019952  28198.121675  ...   1.214423e-88   3.477136e-85
5  FBgn0000566  29547.637372  ...   2.212741e-81   5.279601e-78
6  FBgn0036571   6544.747374  ...   3.794916e-80   7.761145e-77
7  FBgn0036846   6260.685819  ...   1.303967e-71   2.333450e-68
8  FBgn0030102   1918.804536  ...   7.088463e-71   1.127538e-67
9  FBgn0037612   6571.799923  ...   1.777633e-70   2.544860e-67

[10 rows x 7 columns]

==================================================
Column names:
['gene_id', 'baseMean', 'log2FoldChange', 'lfcSE', 'stat', 'pvalue', 'padj']

==================================================
Summary statistics:
Mean log2FoldChange: -1.0609
Min padj: 2.72e-161
Max padj: 9.63e-44
</observation>
Let me check the temporary files and provide a final summary:

<execute>
import os

# Check temp directory contents
temp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate"

print("Temporary files created:")
if os.path.exists(temp_dir):
    files = os.listdir(temp_dir)
    for f in files:
        file_path = os.path.join(temp_dir, f)
        size = os.path.getsize(file_path)
        print(f"  {f} ({size} bytes)")
else:
    print("Temp directory not found")

print("\n" + "="*50)
print("Analysis Summary:")
print("="*50)
print("✓ Loaded 6 DRX experiment count files")
print("✓ Merged count matrix with 17,714 genes")
print("✓ Identified condition: cancer-bearing (3 samples) vs non-cancer control (3 samples)")
print("✓ Identified batch: 2 batches (UAS-bub3IR and en-GAL4)")
print("✓ Performed DESeq2 differential expression analysis")
print("✓ Note: Due to perfect confounding between batch and condition,")
print("  used design = ~ condition (batch correction not possible)")
print("✓ Pre-filtered to 14,339 genes")
print("✓ Found 9,139 significantly differentially expressed genes (padj < 0.05)")
print("✓ Saved top 50 genes to output file")
print("\nOutput file: /root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv")
print("Temp directory: /root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate")
</execute>
<observation>Temporary files created:
  count_matrix.tsv (643975 bytes)
  sample_info_clean.tsv (838 bytes)
  metadata.tsv (440 bytes)
  deseq2_analysis.R (2196 bytes)
  limma_analysis.R (2924 bytes)
  deseq2_simple_analysis.R (2391 bytes)

==================================================
Analysis Summary:
==================================================
✓ Loaded 6 DRX experiment count files
✓ Merged count matrix with 17,714 genes
✓ Identified condition: cancer-bearing (3 samples) vs non-cancer control (3 samples)
✓ Identified batch: 2 batches (UAS-bub3IR and en-GAL4)
✓ Performed DESeq2 differential expression analysis
✓ Note: Due to perfect confounding between batch and condition,
  used design = ~ condition (batch correction not possible)
✓ Pre-filtered to 14,339 genes
✓ Found 9,139 significantly differentially expressed genes (padj < 0.05)
✓ Saved top 50 genes to output file

Output file: /root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv
Temp directory: /root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate
</observation>
<solution>
Differential expression analysis completed successfully!

**Analysis Summary:**

1. **Data Loaded:**
   - 6 DRX experiment count files from `benchmark/dataset/MetazExp/count`
   - Sample information from `benchmark/dataset/MetazExp/sample_info.tsv`
   - Merged count matrix with 17,714 genes across 6 samples

2. **Experimental Design:**
   - **Condition**: cancer-bearing (3 samples) vs non-cancer control (3 samples)
   - **Batch**: 2 batches (UAS-bub3IR and en-GAL4)
   - **Important Note**: There is perfect confounding between batch and condition - all cancer-bearing samples are in one batch, all control samples are in the other batch. This makes it impossible to include both batch and condition in the design formula simultaneously.

3. **DESeq2 Analysis:**
   - Used design formula: `~ condition` (batch correction not possible due to confounding)
   - Pre-filtered to 14,339 genes (≥10 counts in ≥3 samples)
   - Identified 9,139 significantly differentially expressed genes (padj < 0.05)

4. **Results:**
   - Top 50 most significantly differentially expressed genes ranked by adjusted p-value
   - Saved to: `/root/autodl-tmp/biomni_v20260208_pred_results/glm-4.7/metazexp_annotate.tsv`
   - Format: gene_id, baseMean, log2FoldChange, lfcSE, stat, pvalue, padj

5. **Temporary Files:**
   - Saved to: `/root/autodl-tmp/biomni_v20260208_tmp/glm-4.7/metazexp_annotate`
   - Includes: count_matrix.tsv, metadata.tsv, R scripts

The top gene (FBgn0050098) shows a log2FoldChange of -4.89 with padj = 2.72e-161, indicating strong downregulation in cancer-bearing samples compared to controls.
</solution>