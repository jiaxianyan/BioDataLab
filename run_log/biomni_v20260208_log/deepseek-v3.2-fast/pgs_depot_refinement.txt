Filter the provided SNP data in `benchmark/dataset/PGS-Depot/sample.vcf`. 

The filtering criteria are: remove multi-allelic SNPs, remove SNPs with a minor allele frequency (MAF) less than 0.05, and remove SNPs with a genotype missing rate greater than 0.2. 

Save the resulting filtered data as a VCF file named `/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast/pgs_depot_refinement.vcf`.

All intermediate steps should be saved in `/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement` directory.

I'll start by creating a plan to filter the SNP data according to the given criteria.

**Plan:**

1. [ ] Check the environment and locate the input VCF file.
2. [ ] Create the necessary directories for intermediate and output files.
3. [ ] Use appropriate tools (like `bcftools` or `plink`) to filter multi-allelic SNPs, apply MAF threshold, and genotype missing rate.
4. [ ] Save intermediate files as needed.
5. [ ] Save the final filtered VCF to the specified output path.
6. [ ] Verify the filtering results.

Let's start with step 1.

<execute>
import os
import subprocess

# Check if the input file exists
input_vcf = "benchmark/dataset/PGS-Depot/sample.vcf"
if not os.path.exists(input_vcf):
    print(f"Input file {input_vcf} does not exist.")
    # Try to find it with absolute path
    input_vcf = "/root/autodl-tmp/biomni_v20260208_pred_results/benchmark/dataset/PGS-Depot/sample.vcf"
    if not os.path.exists(input_vcf):
        print(f"Input file {input_vcf} does not exist either.")
    else:
        print(f"Found input file at {input_vcf}")
else:
    print(f"Found input file at {input_vcf}")
</execute>
<observation>Found input file at benchmark/dataset/PGS-Depot/sample.vcf
</observation>
1. [✓] Check the environment and locate the input VCF file. (completed)

Now step 2: Create the necessary directories.

<execute>
# Define directories
tmp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
output_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Create directories if they don't exist
os.makedirs(tmp_dir, exist_ok=True)
os.makedirs(output_dir, exist_ok=True)

print(f"Created temporary directory: {tmp_dir}")
print(f"Output directory: {output_dir}")
</execute>
<observation>NameError("name 'os' is not defined")</observation>
I need to import os. Let me fix that.

<execute>
import os
import subprocess

# Define directories
tmp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
output_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Create directories if they don't exist
os.makedirs(tmp_dir, exist_ok=True)
os.makedirs(output_dir, exist_ok=True)

print(f"Created temporary directory: {tmp_dir}")
print(f"Output directory: {output_dir}")
</execute>
<observation>Created temporary directory: /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement
Output directory: /root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast
</observation>
2. [✓] Create the necessary directories for intermediate and output files. (completed)

Now step 3: Use appropriate tools to filter multi-allelic SNPs, apply MAF threshold, and genotype missing rate.

I'll use `bcftools` for filtering because it's efficient for VCF files. Let's check if bcftools is available.

<execute>
# Check if bcftools is installed
try:
    subprocess.run(["bcftools", "--version"], check=True, capture_output=True)
    print("bcftools is available.")
except FileNotFoundError:
    print("bcftools not found. Trying plink.")
</execute>
<observation>NameError("name 'subprocess' is not defined")</observation>
I need to import subprocess again.

<execute>
import subprocess

# Check if bcftools is installed
try:
    subprocess.run(["bcftools", "--version"], check=True, capture_output=True)
    print("bcftools is available.")
except FileNotFoundError:
    print("bcftools not found. Trying plink.")
</execute>
<observation>bcftools not found. Trying plink.
</observation>
Let's check if plink is available.

<execute>
try:
    subprocess.run(["plink", "--version"], check=True, capture_output=True)
    print("plink is available.")
except FileNotFoundError:
    print("plink not found. Trying with pysam.")
</execute>
<observation>NameError("name 'subprocess' is not defined")</observation>
I already imported subprocess in the previous cell, but it seems the environment resets? Let me re-import.

<execute>
import subprocess

try:
    subprocess.run(["plink", "--version"], check=True, capture_output=True)
    print("plink is available.")
except FileNotFoundError:
    print("plink not found. Trying with pysam.")
</execute>
<observation>plink is available.
</observation>
Great, plink is available. I'll use plink for filtering. However, plink works with PLINK binary files (bed/bim/fam). We need to convert VCF to PLINK format first, apply filters, then convert back to VCF.

Let's proceed with step 3: filtering.

First, convert VCF to PLINK binary format.

<execute>
# Define paths
input_vcf = "benchmark/dataset/PGS-Depot/sample.vcf"
plink_prefix = os.path.join(tmp_dir, "sample")

# Convert VCF to PLINK binary
cmd = ["plink", "--vcf", input_vcf, "--make-bed", "--out", plink_prefix]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Conversion failed.")
else:
    print("Conversion successful.")
</execute>
<observation>NameError("name 'os' is not defined")</observation>
Again, need to import os.

<execute>
import os
import subprocess

# Define paths
input_vcf = "benchmark/dataset/PGS-Depot/sample.vcf"
plink_prefix = os.path.join(tmp_dir, "sample")

# Convert VCF to PLINK binary
cmd = ["plink", "--vcf", input_vcf, "--make-bed", "--out", plink_prefix]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Conversion failed.")
else:
    print("Conversion successful.")
</execute>
<observation>NameError("name 'tmp_dir' is not defined")</observation>
I need to define tmp_dir again. Let me re-run the entire cell with all definitions.

<execute>
import os
import subprocess

# Define directories
tmp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
output_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Define paths
input_vcf = "benchmark/dataset/PGS-Depot/sample.vcf"
plink_prefix = os.path.join(tmp_dir, "sample")

# Convert VCF to PLINK binary
cmd = ["plink", "--vcf", input_vcf, "--make-bed", "--out", plink_prefix]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Conversion failed.")
else:
    print("Conversion successful.")
</execute>
<observation>Running: plink --vcf benchmark/dataset/PGS-Depot/sample.vcf --make-bed --out /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample
STDOUT: PLINK v1.9.0-b.7.7 64-bit (22 Oct 2024)            cog-genomics.org/plink/1.9/
(C) 2005-2024 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample.log.
Options in effect:
  --make-bed
  --out /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample
  --vcf benchmark/dataset/PGS-Depot/sample.vcf

515593 MB RAM detected; reserving 257796 MB for main workspace.

--vcf:
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample-temporary.bed
+
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample-temporary.bim
+
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample-temporary.fam
written.
9 variants loaded from .bim file.
3 people (0 males, 0 females, 3 ambiguous) loaded from .fam.
Ambiguous sex IDs written to
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample.nosex
.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 3 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is 0.814815.
9 variants and 3 people pass filters and QC.
Note: No phenotypes present.
--make-bed to
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample.bed
+
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample.bim
+
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample.fam
... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.

STDERR: 
Conversion successful.
</observation>
Great. Now we have PLINK binary files. Next, we need to apply filters:

1. Remove multi-allelic SNPs: In PLINK, multi-allelic SNPs are those with more than two alleles. We can use `--snps-only just-acgt` to keep only SNPs with A/C/G/T alleles and biallelic? Actually, we can use `--biallelic-only` to keep only biallelic SNPs.

2. Remove SNPs with MAF < 0.05: `--maf 0.05`

3. Remove SNPs with genotype missing rate > 0.2: `--geno 0.2` (geno filters variants based on missing genotype rate).

Let's apply these filters.

<execute>
# Apply filters
filtered_prefix = os.path.join(tmp_dir, "sample_filtered")
cmd = [
    "plink",
    "--bfile", plink_prefix,
    "--biallelic-only", "strict",
    "--maf", "0.05",
    "--geno", "0.2",
    "--make-bed",
    "--out", filtered_prefix
]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Filtering failed.")
else:
    print("Filtering successful.")
</execute>
<observation>NameError("name 'os' is not defined")</observation>
Again, need to import os and subprocess.

<execute>
import os
import subprocess

# Define directories
tmp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
output_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Define paths
plink_prefix = os.path.join(tmp_dir, "sample")
filtered_prefix = os.path.join(tmp_dir, "sample_filtered")

# Apply filters
cmd = [
    "plink",
    "--bfile", plink_prefix,
    "--biallelic-only", "strict",
    "--maf", "0.05",
    "--geno", "0.2",
    "--make-bed",
    "--out", filtered_prefix
]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Filtering failed.")
else:
    print("Filtering successful.")
</execute>
<observation>Running: plink --bfile /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample --biallelic-only strict --maf 0.05 --geno 0.2 --make-bed --out /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered
STDOUT: PLINK v1.9.0-b.7.7 64-bit (22 Oct 2024)            cog-genomics.org/plink/1.9/
(C) 2005-2024 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.log.
Options in effect:
  --bfile /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample
  --biallelic-only strict
  --geno 0.2
  --maf 0.05
  --make-bed
  --out /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered

515593 MB RAM detected; reserving 257796 MB for main workspace.
9 variants loaded from .bim file.
3 people (0 males, 0 females, 3 ambiguous) loaded from .fam.
Ambiguous sex IDs written to
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.nosex
.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 3 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is 0.814815.
4 variants removed due to missing genotype data (--geno).
1 variant removed due to minor allele threshold(s)
(--maf/--max-maf/--mac/--max-mac).
4 variants and 3 people pass filters and QC.
Note: No phenotypes present.
--make-bed to
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.bed
+
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.bim
+
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.fam
... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.

STDERR: 
Filtering successful.
</observation>
Great! Filtering successful. According to the log: 9 variants originally, 4 removed due to missing genotype data (--geno), 1 removed due to MAF threshold, leaving 4 variants.

Now we need to convert the filtered PLINK binary back to VCF format.

<execute>
# Convert filtered PLINK binary back to VCF
vcf_filtered = os.path.join(tmp_dir, "sample_filtered.vcf")
cmd = [
    "plink",
    "--bfile", filtered_prefix,
    "--recode", "vcf",
    "--out", filtered_prefix
]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Conversion to VCF failed.")
else:
    print("Conversion to VCF successful.")
</execute>
<observation>NameError("name 'os' is not defined")</observation>
Again, need to import.

<execute>
import os
import subprocess

# Define directories
tmp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
output_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Define paths
filtered_prefix = os.path.join(tmp_dir, "sample_filtered")

# Convert filtered PLINK binary back to VCF
cmd = [
    "plink",
    "--bfile", filtered_prefix,
    "--recode", "vcf",
    "--out", filtered_prefix
]
print("Running:", " ".join(cmd))
result = subprocess.run(cmd, capture_output=True, text=True)
print("STDOUT:", result.stdout)
print("STDERR:", result.stderr)
if result.returncode != 0:
    print("Conversion to VCF failed.")
else:
    print("Conversion to VCF successful.")
</execute>
<observation>Running: plink --bfile /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered --recode vcf --out /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered
STDOUT: PLINK v1.9.0-b.7.7 64-bit (22 Oct 2024)            cog-genomics.org/plink/1.9/
(C) 2005-2024 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.log.
Options in effect:
  --bfile /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered
  --out /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered
  --recode vcf

515593 MB RAM detected; reserving 257796 MB for main workspace.
4 variants loaded from .bim file.
3 people (0 males, 0 females, 3 ambiguous) loaded from .fam.
Ambiguous sex IDs written to
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.nosex
.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 3 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
4 variants and 3 people pass filters and QC.
Note: No phenotypes present.
--recode vcf to
/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.vcf
... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.

STDERR: 
Conversion to VCF successful.
</observation>
Now we have the filtered VCF at `/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.vcf`. We need to copy it to the final output location.

But note: the output file name is `pgs_depot_refinement.vcf` in the output directory. Let's copy it.

Also, we should verify that the filtering criteria are met: no multi-allelic SNPs, MAF >= 0.05, missing rate <= 0.2.

Let's first copy the file.

<execute>
import shutil

# Source VCF
source_vcf = os.path.join(tmp_dir, "sample_filtered.vcf")
# Destination
dest_vcf = output_vcf

shutil.copy2(source_vcf, dest_vcf)
print(f"Copied filtered VCF from {source_vcf} to {dest_vcf}")
</execute>
<observation>NameError("name 'os' is not defined")</observation>
I'll import os and shutil.

<execute>
import os
import shutil

# Define directories
tmp_dir = "/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement"
output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
output_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Source VCF
source_vcf = os.path.join(tmp_dir, "sample_filtered.vcf")
# Destination
dest_vcf = output_vcf

shutil.copy2(source_vcf, dest_vcf)
print(f"Copied filtered VCF from {source_vcf} to {dest_vcf}")
</execute>
<observation>Copied filtered VCF from /root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement/sample_filtered.vcf to /root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast/pgs_depot_refinement.vcf
</observation>
Now we should verify the filtering results. Let's read the filtered VCF and check the number of variants, MAF, missing rate, and multi-allelic status.

We can use pysam to read VCF.

<execute>
import pysam

# Read the filtered VCF
vcf = pysam.VariantFile(dest_vcf)
print("Filtered VCF header:", vcf.header)
count = 0
for record in vcf:
    count += 1
    # Check if multi-allelic (more than one alternate allele)
    if len(record.alts) > 1:
        print(f"WARNING: Multi-allelic SNP found: {record.chrom}:{record.pos} alts={record.alts}")
    # Calculate MAF
    # Get allele frequencies from INFO if available, otherwise compute from genotypes
    # For simplicity, we'll just print the record
    # We'll compute missing rate later
print(f"Total variants in filtered VCF: {count}")
vcf.close()
</execute>
<observation>NameError("name 'dest_vcf' is not defined")</observation>
Define dest_vcf again.

<execute>
import os
import pysam

output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
dest_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

# Read the filtered VCF
vcf = pysam.VariantFile(dest_vcf)
print("Filtered VCF header:", vcf.header)
count = 0
for record in vcf:
    count += 1
    # Check if multi-allelic (more than one alternate allele)
    if len(record.alts) > 1:
        print(f"WARNING: Multi-allelic SNP found: {record.chrom}:{record.pos} alts={record.alts}")
    # Calculate MAF
    # Get allele frequencies from INFO if available, otherwise compute from genotypes
    # For simplicity, we'll just print the record
    # We'll compute missing rate later
print(f"Total variants in filtered VCF: {count}")
vcf.close()
</execute>
<observation>Filtered VCF header: ##fileformat=VCFv4.2
##FILTER=<ID=PASS,Description="All filters passed">
##fileDate=20260208
##source=PLINKv1.9
##contig=<ID=19,length=113>
##contig=<ID=20,length=17331>
##INFO=<ID=PR,Number=0,Type=Flag,Description="Provisional reference allele, may not be based on real reference genome">
##FORMAT=<ID=GT,Number=1,Type=String,Description="Genotype">
#CHROM	POS	ID	REF	ALT	QUAL	FILTER	INFO	FORMAT	NA00001_NA00001	NA00002_NA00002	NA00003_NA00003

Total variants in filtered VCF: 4
</observation>
Now we need to compute MAF and missing rate for each variant to ensure they meet criteria. Let's write a more thorough verification.

<execute>
import pysam
import numpy as np

vcf = pysam.VariantFile(dest_vcf)
total_variants = 0
multi_allelic = 0
low_maf = 0
high_missing = 0

for record in vcf:
    total_variants += 1
    # Check multi-allelic
    if len(record.alts) > 1:
        multi_allelic += 1
        print(f"Multi-allelic SNP: {record.chrom}:{record.pos} alts={record.alts}")
    
    # Compute missing rate and allele counts
    genotypes = []
    for sample in record.samples.values():
        gt = sample['GT']
        if gt is None or gt == (None, None):
            genotypes.append(-1)  # missing
        else:
            # Assuming diploid
            genotypes.extend(gt)
    
    # Convert to array
    genotypes = np.array(genotypes)
    # Count missing
    missing_count = np.sum(genotypes == -1)
    total_genotypes = len(genotypes)
    missing_rate = missing_count / total_genotypes if total_genotypes > 0 else 0
    if missing_rate > 0.2:
        high_missing += 1
        print(f"High missing rate SNP: {record.chrom}:{record.pos} missing_rate={missing_rate}")
    
    # Compute allele frequencies (excluding missing)
    valid_genotypes = genotypes[genotypes != -1]
    if len(valid_genotypes) > 0:
        # Count alleles (0 for REF, 1 for ALT)
        allele_counts = np.bincount(valid_genotypes, minlength=2)
        total_alleles = len(valid_genotypes)
        # MAF is frequency of minor allele
        freq_ref = allele_counts[0] / total_alleles
        freq_alt = allele_counts[1] / total_alleles if len(allele_counts) > 1 else 0
        maf = min(freq_ref, freq_alt)
        if maf < 0.05:
            low_maf += 1
            print(f"Low MAF SNP: {record.chrom}:{record.pos} MAF={maf}")
    else:
        # All missing
        print(f"All genotypes missing for SNP: {record.chrom}:{record.pos}")

vcf.close()

print("\nVerification summary:")
print(f"Total variants: {total_variants}")
print(f"Multi-allelic SNPs: {multi_allelic}")
print(f"SNPs with MAF < 0.05: {low_maf}")
print(f"SNPs with missing rate > 0.2: {high_missing}")
</execute>
<observation>NameError("name 'dest_vcf' is not defined")</observation>
Define dest_vcf again.

<execute>
import os
import pysam
import numpy as np

output_dir = "/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast"
dest_vcf = os.path.join(output_dir, "pgs_depot_refinement.vcf")

vcf = pysam.VariantFile(dest_vcf)
total_variants = 0
multi_allelic = 0
low_maf = 0
high_missing = 0

for record in vcf:
    total_variants += 1
    # Check multi-allelic
    if len(record.alts) > 1:
        multi_allelic += 1
        print(f"Multi-allelic SNP: {record.chrom}:{record.pos} alts={record.alts}")
    
    # Compute missing rate and allele counts
    genotypes = []
    for sample in record.samples.values():
        gt = sample['GT']
        if gt is None or gt == (None, None):
            genotypes.append(-1)  # missing
        else:
            # Assuming diploid
            genotypes.extend(gt)
    
    # Convert to array
    genotypes = np.array(genotypes)
    # Count missing
    missing_count = np.sum(genotypes == -1)
    total_genotypes = len(genotypes)
    missing_rate = missing_count / total_genotypes if total_genotypes > 0 else 0
    if missing_rate > 0.2:
        high_missing += 1
        print(f"High missing rate SNP: {record.chrom}:{record.pos} missing_rate={missing_rate}")
    
    # Compute allele frequencies (excluding missing)
    valid_genotypes = genotypes[genotypes != -1]
    if len(valid_genotypes) > 0:
        # Count alleles (0 for REF, 1 for ALT)
        allele_counts = np.bincount(valid_genotypes, minlength=2)
        total_alleles = len(valid_genotypes)
        # MAF is frequency of minor allele
        freq_ref = allele_counts[0] / total_alleles
        freq_alt = allele_counts[1] / total_alleles if len(allele_counts) > 1 else 0
        maf = min(freq_ref, freq_alt)
        if maf < 0.05:
            low_maf += 1
            print(f"Low MAF SNP: {record.chrom}:{record.pos} MAF={maf}")
    else:
        # All missing
        print(f"All genotypes missing for SNP: {record.chrom}:{record.pos}")

vcf.close()

print("\nVerification summary:")
print(f"Total variants: {total_variants}")
print(f"Multi-allelic SNPs: {multi_allelic}")
print(f"SNPs with MAF < 0.05: {low_maf}")
print(f"SNPs with missing rate > 0.2: {high_missing}")
</execute>
<observation>
Verification summary:
Total variants: 4
Multi-allelic SNPs: 0
SNPs with MAF < 0.05: 0
SNPs with missing rate > 0.2: 0
</observation>
Great! All filtering criteria are satisfied. Now we have completed the task.

Let's update the plan checklist.

**Updated Plan:**

1. [✓] Check the environment and locate the input VCF file. (completed)
2. [✓] Create the necessary directories for intermediate and output files. (completed)
3. [✓] Use appropriate tools (like `bcftools` or `plink`) to filter multi-allelic SNPs, apply MAF threshold, and genotype missing rate. (completed)
4. [✓] Save intermediate files as needed. (completed)
5. [✓] Save the final filtered VCF to the specified output path. (completed)
6. [✓] Verify the filtering results. (completed)

All steps are completed. Now we can provide the solution.

<solution>
The SNP data from `benchmark/dataset/PGS-Depot/sample.vcf` has been filtered according to the criteria: multi-allelic SNPs removed, SNPs with MAF < 0.05 removed, and SNPs with genotype missing rate > 0.2 removed. The filtered VCF file is saved at `/root/autodl-tmp/biomni_v20260208_pred_results/deepseek-v3.2-fast/pgs_depot_refinement.vcf`. Intermediate files are stored in `/root/autodl-tmp/biomni_v20260208_tmp/deepseek-v3.2-fast/pgs_depot_refinement`. Verification confirms that the filtered dataset contains 4 variants, all biallelic, with MAF ≥ 0.05 and missing rate ≤ 0.2.
</solution>